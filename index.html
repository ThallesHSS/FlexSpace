<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FlexSpace ‚Äî Demo Corporativa</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f5fefd;
    --card: #ffffff;
    --muted: #6b7a80;
    --brand: #2bc3cc;
    --accent: #32ebc0;
    --text: #053f4e;
    --glass: rgba(255,255,255,0.6);
    --shadow: 0 8px 24px rgba(6,20,25,0.08);
    --radius: 14px;
    --soft-radius: 10px;
    --transition: 250ms cubic-bezier(.2,.9,.3,1);
  }


  /* dark */
  .dark {
    --bg: #0f1720;
    --card: #0b1220;
    --muted: #9aa7b0;
    --brand: #6a9bd6;
    --accent: #7fd3d1;
    --text: #e6f0f3;
    --glass: rgba(255,255,255,0.03);
    --shadow: 0 10px 30px rgba(2,6,12,0.6);
  }

  /* alto contraste */
.high-contrast {
  --bg: #000000;
  --card: #000000;
  --muted: #ffffff;
  --brand: #ffff00;
  --accent: #00ffff;
  --text: #ffffff;
  --glass: rgba(255,255,255,0.15);
  --shadow: none;
}

.high-contrast a,
.high-contrast button,
.high-contrast select,
.high-contrast input {
  border: 2px solid #ffffff !important;
  color: #ffffff !important;
  background: #000000 !important;
}

.high-contrast .btn.primary {
  background: #ffff00 !important;
  color: #000000 !important;
}

.high-contrast .logo {
  background: linear-gradient(135deg, #ffff00, #00ffff) !important;
}


  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,var(--bg), #eafefefd 120%);
    color:var(--text);
    margin:0; -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color:transparent;
  }


  /* Header */
  header{
    position:sticky; top:0; z-index:60;
    backdrop-filter: blur(6px);
    background: linear-gradient(90deg, rgba(255,255,255,0.55), rgba(255,255,255,0.35));
    border-bottom: 1px solid rgba(0,0,0,0.04);
    padding:12px 20px; display:flex; align-items:center; justify-content:space-between;
  }
  .dark header{
    background: linear-gradient(90deg, rgba(10,14,20,0.6), rgba(10,14,20,0.4));
    border-bottom-color: rgba(255,255,255,0.03);
  }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background:linear-gradient(135deg,var(--brand),var(--accent));
    box-shadow: var(--shadow);
    display:grid; place-items:center; color:#fff; font-weight:700;
  }
  .brand h1{font-size:1rem;margin:0}
  nav.topnav{display:flex; gap:18px; align-items:center;}
  nav.topnav a{color:var(--text); text-decoration:none; font-weight:600; opacity:.95; font-size:.95rem}
  nav.topnav a:hover{opacity:1; transform:translateY(-2px)}
  .controls{display:flex; gap:10px; align-items:center}
  button.icon-btn{
    border:0; background:transparent; padding:8px; border-radius:10px; cursor:pointer;
    display:inline-grid; place-items:center; transition:all var(--transition);
  }
  button.icon-btn:hover{transform:translateY(-3px)}


  /* Layout */
  main{max-width:1100px;margin:24px auto;padding:0 20px;}
  .hero{
    display:grid; grid-template-columns: 1fr 420px; gap:28px; align-items:center;
    margin-bottom:28px;
  }
  .hero-card{
    background:var(--card); border-radius:var(--radius); padding:28px;
    box-shadow:var(--shadow); transition:transform var(--transition);
  }
  .hero-card h2{margin:0 0 8px;font-size:1.6rem;letter-spacing:-0.2px}
  .hero-card p{color:var(--muted); margin:0 0 18px}
  .hero-actions{display:flex; gap:12px; margin-top:10px}
  .btn{padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--brand); color:#fff; box-shadow: 0 8px 18px rgba(43,195,204,0.18)}
  .btn.ghost{background:transparent; border:1px solid rgba(0,0,0,0.06)}


  .hero-visual{
    border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
    height:260px; background-size:cover; background-position:center;
  }


  /* Search & filter */
  .searchbar{display:flex; gap:12px; margin-top:14px; align-items:center}
  .searchbar input{
    flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);
    background:var(--glass); color:var(--text);
  }
  .searchbar select{
    padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);
    background:var(--card); color:var(--text);
  }


  /* Grid cards */
  .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:18px; margin-top:18px;}
  .card{
    background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    display:flex; flex-direction:column; transition:transform var(--transition), box-shadow var(--transition);
    min-height:320px;
  }
  .card:hover{transform:translateY(-8px); box-shadow: 0 22px 40px rgba(6,20,25,0.12)}
  .card-media{height:150px; background-size:cover; background-position:center}
  .card-body{padding:14px 16px; display:flex; flex-direction:column; gap:10px; flex:1}
  .card-title{font-weight:700; font-size:1.05rem}
  .card-desc{color:var(--muted); font-size:0.95rem; flex:1}
  .card-footer{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .card-actions{display:flex; gap:8px; align-items:center}


  /* rating */
  .stars{display:flex; gap:6px; align-items:center}
  .star{
    font-size:20px; color: #cbd5d9; cursor:pointer; transition: color 180ms;
    text-shadow: 0 1px 0 rgba(0,0,0,0.06);
    user-select:none;
  }
  .star.on{ color: #ffd65a; }
  .rating-count{color:var(--muted); font-size:0.85rem}


  /* overlay quick */
  .overlay-trigger{position:absolute; inset:12px; border-radius:12px; pointer-events:none}
  .card .card-overlay{
    position:absolute; right:12px; top:12px; background:rgba(0,0,0,0.05); padding:6px;border-radius:10px; pointer-events:auto;
  }


  /* footer */
  footer.site-footer{margin:36px auto 80px; text-align:center; color:var(--muted); font-size:0.95rem}


  /* responsive */
  @media (max-width:980px){
    .hero{grid-template-columns:1fr; gap:16px}
    .grid{grid-template-columns:repeat(2,1fr)}
    .hero-visual{height:200px}
  }
  @media (max-width:620px){
    header{padding:12px}
    nav.topnav{display:none}
    .grid{grid-template-columns:1fr}
    .hero-visual{height:160px}
    .hero-card{padding:18px}
  }


  /* subtle helpers */
  .muted{color:var(--muted)}
  .small{font-size:.85rem}
  a.btn-link{color:var(--brand); text-decoration:none; font-weight:600}
  /* accessibility focus */
  .star:focus, .icon-btn:focus, .btn:focus, input:focus, select:focus{outline:3px solid rgba(43,195,204,0.14); outline-offset:2px}
</style>
</head>
<body>


<header role="banner" aria-label="Cabe√ßalho do site">
  <div class="brand">
    <div class="logo" aria-hidden="true"><img src="https://thalleshss.github.io/FlexSpace/Logo flexspace.jfif" class="logo" aria-hidden="true"></div>
    <div>
      <h1 style="font-size:0.95rem;margin:0">FlexSpace</h1>
      <div class="small muted">Demonstra√ß√£o Corporativa</div>
    </div>
  </div>


  <nav class="topnav" role="navigation" aria-label="Menu principal">
    <a href="#sobre">Perfil</a>
    <a href="#espacos">Minha Empresa</a>
    <a href="#contato">Configura√ß√µes</a>
  </nav>


 <div class="controls" aria-hidden="false">
  <button class="icon-btn" id="toggleTheme" title="Alternar tema (lido pelo leitor)">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="currentColor"/>
    </svg>
  </button>

  <!-- novo bot√£o de acessibilidade -->
  <button class="icon-btn" id="toggleReader" title="Ativar leitor de texto" aria-label="Ativar leitor de texto">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M3 10v4a1 1 0 001 1h2l3 3V6L6 9H4a1 1 0 00-1 1zm13.54-3.54a5 5 0 010 7.07m2.83-9.9a9 9 0 010 12.73"
        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <button class="icon-btn" title="Ajuda" aria-label="Ajuda">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM11 17h2v-2h-2v2zm2.07-7.75a2 2 0 10-3.14 1.76"
        stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

   <button class="icon-btn" id="toggleContrast" title="Ativar alto contraste" aria-label="Ativar alto contraste">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
    <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 6v12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
  </svg>
</button>
</div>
</header>


<main>
  <!-- HERO -->
  <section class="hero" aria-labelledby="hero-title">
    <div class="hero-card" role="region" aria-label="Informa√ß√µes sobre a demonstra√ß√£o">
      <h2 id="hero-title">Demonstra√ß√£o FlexSpace ‚Äî Contabilidade XYZ</h2>
      <p>Gerencie, visualize e avalie os espa√ßos da sua empresa. Clique em um espa√ßo para ver op√ß√µes, ou avalie com estrelas.</p>


      <div class="searchbar" role="search">
        <input id="searchInput" placeholder="Procurar espa√ßo (ex: Sala de reuni√£o, Banheiro...)" aria-label="Procurar espa√ßos">
        <select id="filterSelect" aria-label="Filtrar por tipo">
          <option value="">Todos os tipos</option>
          <option value="escritorio">Escrit√≥rio</option>
          <option value="reuniao">Sala de Reuni√£o</option>
          <option value="banheiro">Banheiro</option>
          <option value="comum">√Årea Comum</option>
        </select>
        <button class="btn primary" id="newDemoBtn">Agendar Demo</button>
      </div>


      <div style="margin-top:14px; display:flex; gap:12px; align-items:center;">
        <div class="muted small">Exibindo <strong id="visibleCount">0</strong> espa√ßos</div>
        <div style="flex:1"></div>
        <a href="#espacos" class="btn ghost">Ver espa√ßos</a>
      </div>
    </div>


    <div class="hero-visual" role="img" aria-label="Imagem de ambiente corporativo" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZQ6JzKX9La8o_2GV68nfg5YB9cI9DaAyhbw&s');"></div>
  </section>


  <!-- CARDS -->
  <section id="espacos" class="section" aria-labelledby="espacos-title">
    <h3 id="espacos-title" style="margin:0 0 8px">Espa√ßos Dispon√≠veis</h3>
    <p class="muted small" style="margin-top:0">Passe o mouse (ou toque) nos cards para ver op√ß√µes r√°pidas. Avalie cada espa√ßo com as estrelas.</p>


    <div class="grid" id="cardsGrid" aria-live="polite">
      <!-- cards ser√£o inseridos por JS -->
    </div>
  </section>


  <!-- Sobre / contato -->
  <section id="sobre" style="margin-top:30px; display:flex; gap:20px; align-items:flex-start;">
    <div style="flex:1" class="hero-card">
      <h4 style="margin-top:0">Sobre a Empresa</h4>
      <p class="muted">A Contabilidade XYZ utiliza a FlexSpace para gerenciar salas de reuni√µes, escrit√≥rios e √°reas comuns. Aqui √© s√≥ uma demonstra√ß√£o que mostra a interface e intera√ß√µes com os espa√ßos.</p>
      <p class="small muted">Este prot√≥tipo n√£o grava em servidor ‚Äî as avalia√ß√µes ficam salvas apenas no seu navegador.</p>
    </div>


    <div style="width:320px" class="hero-card">
      <h4 style="margin-top:0">Contato</h4>
      <p class="muted small">Demo / Suporte: <strong>demo@flexspace.com</strong></p>
      <p style="margin-top:12px"><a href="#" class="btn primary" style="width:100%;text-align:center">Solicitar apresenta√ß√£o</a></p>
    </div>
  </section>
</main>


<footer class="site-footer" role="contentinfo">
  FlexSpace ¬© <span id="year"></span> ‚Äî Esta √© uma demonstra√ß√£o corporativa. Layout inspirado em aplicativos e sites organizacionais.
</footer>


<script>
/* Data inicial dos espa√ßos (voc√™ pode editar, carregar via API etc.) */
const spaces = [
  { id: 'esp-1', type:'escritorio', title:'Escrit√≥rio Principal', desc:'Espa√ßo moderno para a equipe trabalhar de forma confort√°vel.', img:'https://www.divdesign.com.br/wp-content/uploads/2021/11/tendencias-moveis-escritorio-div-design.jpg' },
  { id: 'esp-2', type:'reuniao', title:'Sala de Reuni√£o', desc:'Sala equipada para apresenta√ß√µes e reuni√µes com clientes.', img:'https://funcional.wpcdn.com.br/blog/2023/05/FUNCIONAL_blog_16-05-1.png' },
  { id: 'esp-3', type:'banheiro', title:'Banheiros', desc:'Banheiros limpos e acess√≠veis para equipe e visitantes.', img:'https://s32907.pcdn.co/wp-content/uploads/2020/03/revestimento-de-banheiro-01032020.jpg' },
  { id: 'esp-4', type:'lazer', title:'√Årea Comum', desc:'Lounge e caf√© para pausas, networking e eventos internos.', img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMcmmlozZlIxAUweMOYjzeRhITuLolo-TrkA&s' },
  { id: 'esp-5', type:'escritorio', title:'Escrit√≥rio Financeiro', desc:'Ambiente reservado para equipe financeira e reuni√µes confidenciais.', img:'https://cdn.cobrefacil.com.br/website/base/650/c4c/a7b/departamento-financeiro.jpg' },
  { id: 'esp-6', type:'lazer', title:'Sala de Lazer', desc:'Sala grande e aconchegante para o descanso dos funcion√°rios.', img:'https://qtmov.com.br/blog/wp-content/uploads/2023/06/blog-O-que-nao-pode-faltar-em-uma-sala-de-descanso-na-empresa-qtmov.jpeg' },
  { id: 'esp-7', type:'reuniao', title:'Sala de Treinamento', desc:'Sala grande com projetor para treinamentos e workshops.', img:'https://images.unsplash.com/photo-1542744173-8e7e53415bb0?q=80&w=1200&auto=format&fit=crop' },
  { id: 'esp-8', type:'alimenta√ß√£o', title:'Cantina', desc:'Cantina onde os funcion√°rios podem comprar seus lanches.', img:'https://img.freepik.com/fotos-premium/cantina-de-uma-empresa-start-up-moderna_260036-237.jpg' },
  { id: 'esp-9', type:'alimenta√ß√£o', title:'Pra√ßa de alimenta√ß√£o', desc:'Local onde os funcion√°rios se alimentam e interagem entre s√≠.', img:'https://png.pngtree.com/png-clipart/20200701/original/pngtree-three-dimensional-company-canteen-png-image_5406368.jpg' },
];


/* Utils: rating persistence in localStorage */
const STORAGE_KEY = 'flexspace_ratings_v1';
function loadRatings(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){return {} } }
function saveRatings(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }


/* Render cards */
const grid = document.getElementById('cardsGrid');
const visibleCount = document.getElementById('visibleCount');


function createCard(space, ratingState){
  const card = document.createElement('article');
  card.className = 'card';
  card.setAttribute('data-id', space.id);
  card.setAttribute('tabindex', '0');
  card.innerHTML = `
    <div class="card-media" style="background-image: url('${space.img}')"></div>
    <div class="card-body">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="flex:1">
          <div class="card-title">${space.title}</div>
          <div class="card-desc">${space.desc}</div>
        </div>
      </div>


      <div class="card-footer" style="margin-top:8px">
        <div>
          <div class="stars" role="radiogroup" aria-label="Avalia√ß√£o de ${space.title}">
            ${[1,2,3,4,5].map(i => `<span class="star" role="radio" tabindex="0" data-value="${i}" aria-checked="${(ratingState||0)===i? 'true':'false'}" title="${i} estrela">${i<= (ratingState||0) ? '&#9733;':'&#9733;'}</span>`).join('')}
          </div>
          <div class="rating-count small muted" style="margin-top:6px"><span class="rating-value">${ratingState||0}</span> ‚òÖ ‚Äî <span class="small muted">base: demo</span></div>
        </div>
        <div class="card-actions">
          <button class="btn" data-action="details" aria-label="Detalhes de ${space.title}">Detalhes</button>
          <button class="btn primary" data-action="book" aria-label="Agendar ${space.title}">Agendar</button>
        </div>
      </div>
    </div>
  `;
  attachStarHandlers(card, space.id);
  attachActionHandlers(card, space);
  return card;
}


/* Attach actions */
function attachActionHandlers(card, space){
  card.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const act = btn.getAttribute('data-action');
      if(act==='details'){
        const links = {
          'Escrit√≥rio Principal': 'https://thalleshss.github.io/FlexSpace/FlexDt/Detalhes%20escrit%C3%B3rio.html',
          'Sala de Reuni√£o': 'https://thalleshss.github.io/FlexSpace/FlexDt/Detalhes%20sala%20reuni%C3%A3o.html',
          'Banheiros': 'https://thalleshss.github.io/FlexSpace/FlexDt/Banheiros%20dt.html',
          '√Årea Comum': 'https://thalleshss.github.io/FlexSpace/FlexDt/Arc%20dt.html',
          'Escrit√≥rio Financeiro': 'https://thalleshss.github.io/FlexSpace/FlexDt/Escfndt.html',
          'Sala de Lazer': 'https://thalleshss.github.io/FlexSpace/FlexDt/sllzdt.html',
          'Sala de Treinamento': 'https://thalleshss.github.io/FlexSpace/FlexDt/strdt.html',
          'Cantina': 'https://thalleshss.github.io/FlexSpace/FlexDt/Ctdt.html',
          'Pra√ßa de alimenta√ß√£o': 'https://thalleshss.github.io/FlexSpace/FlexDt/padt.html'
        };

        const url = links[space.title];
        if(url){
          window.location.href = url;
        } else {
          alert(`P√°gina de detalhes n√£o encontrada para: ${space.title}`);
        }
      } 
      else if(act==='book'){
        alert(`Abrir agendamento para: ${space.title}\n\n(Simula√ß√£o demo)`);
      }
    });
  });
}


/* Stars handlers (hover + click + keyboard) */
function attachStarHandlers(card, id){
  const stars = card.querySelectorAll('.star');
  const ratingEl = card.querySelector('.rating-value');
  let ratings = loadRatings();
  let current = ratings[id] || 0;


  function updateVisual(n){
    stars.forEach((s, i)=> s.classList.toggle('on', i < n));
    ratingEl.textContent = n;
  }
  updateVisual(current);


  stars.forEach((s, idx)=>{
    const val = idx+1;
    // pointer
    s.addEventListener('mouseenter', ()=> updateVisual(val));
    s.addEventListener('mouseleave', ()=> updateVisual(ratings[id] || 0));
    s.addEventListener('click', ()=>{
      ratings[id] = val;
      saveRatings(ratings);
      updateVisual(val);
      // feedback
      s.closest('.card').style.boxShadow = '0 30px 50px rgba(43,195,204,0.08)';
    });
    // keyboard accessibility
    s.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){
        ev.preventDefault();
        ratings[id] = val;
        saveRatings(ratings);
        updateVisual(val);
      } else if(ev.key === 'ArrowLeft' || ev.key==='ArrowDown'){
        ev.preventDefault();
        const newVal = Math.max(0, (ratings[id]||0) - 1);
        ratings[id] = newVal; saveRatings(ratings); updateVisual(newVal);
      } else if(ev.key === 'ArrowRight' || ev.key==='ArrowUp'){
        ev.preventDefault();
        const newVal = Math.min(5, (ratings[id]||0) + 1);
        ratings[id] = newVal; saveRatings(ratings); updateVisual(newVal);
      }
    });
  });
}


/* Initial mount */
function mountCards(list){
  grid.innerHTML = '';
  const ratings = loadRatings();
  list.forEach(s => {
    const r = ratings[s.id] || 0;
    grid.appendChild(createCard(s, r));
  });
  visibleCount.textContent = list.length;
}


/* Filters & search */
const searchInput = document.getElementById('searchInput');
  const filterSelect = document.getElementById('filterSelect');


  function populateFilterOptions() {
    const tipos = new Set();
    spaces.forEach(space => {
      if (space.type && space.type.trim() !== '') {
        tipos.add(space.type.trim());
      }
    });
    filterSelect.innerHTML = '<option value="">Todos</option>';
    tipos.forEach(tipo => {
      const option = document.createElement('option');
      option.value = tipo;
      option.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
      filterSelect.appendChild(option);
    });
  }


  function filterAndRender() {
    const q = (searchInput.value || '').toLowerCase().trim();
    const type = filterSelect.value;
    const filtered = spaces.filter(s => {
      if (type && s.type !== type) return false;
      if (!q) return true;
      return (s.title + ' ' + s.desc + ' ' + s.type).toLowerCase().includes(q);
    });
    mountCards(filtered);
  }


  function debounce(fn, t) {
    let to;
    return (...a) => {
      clearTimeout(to);
      to = setTimeout(() => fn(...a), t);
    };
  }


  populateFilterOptions();
  searchInput.addEventListener('input', debounce(filterAndRender, 180));
  filterSelect.addEventListener('change', filterAndRender);


/* Theme toggle */
const toggleThemeBtn = document.getElementById('toggleTheme');
const html = document.documentElement;
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
let usingDark = (localStorage.getItem('flexspace_theme') === 'dark') || prefersDark;
function applyTheme(){
  if(usingDark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
  localStorage.setItem('flexspace_theme', usingDark ? 'dark' : 'light');
}
toggleThemeBtn.addEventListener('click', ()=>{ usingDark = !usingDark; applyTheme(); });
applyTheme();


/* small helpers */
document.getElementById('year').textContent = new Date().getFullYear();
document.getElementById('newDemoBtn').addEventListener('click', ()=>alert('Solicita√ß√£o de demo enviada (simulada).'));
mountCards(spaces);


/* keyboard: focus first card with ArrowDown */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'j' || e.key === 'ArrowDown'){
    const first = document.querySelector('.card');
    if(first) first.focus();
  }
});


/* touch behavior: show overlay on tap by focusing */
grid.addEventListener('click', (ev)=>{
  const card = ev.target.closest('.card');
  if(!card) return;
  // on small screens we might want to open details directly
  if(window.innerWidth < 700){
    const title = card.querySelector('.card-title').textContent;
    alert(`${title}\n\nOp√ß√µes: Detalhes / Agendar (simula√ß√£o)`);
  }
});


/* quick: update visible count after rating change (so UI reacts) */
window.addEventListener('storage', ()=>{ filterAndRender(); });


/* ====== Leitor de Texto Acess√≠vel ====== */
const readerBtn = document.getElementById('toggleReader');
let reading = false;
let synth = window.speechSynthesis;
let utterance = null;

function getPageText() {
  // pega o conte√∫do textual principal da p√°gina
  const mainText = document.body.innerText
    .replace(/\s+/g, ' ')
    .replace(/Detalhes|Agendar/g, '') // remove bot√µes repetitivos
    .trim();
  return mainText;
}

function startReading() {
  if (synth.speaking) synth.cancel();
  utterance = new SpeechSynthesisUtterance(getPageText());
  utterance.lang = 'pt-BR';
  utterance.rate = 1.0;
  utterance.pitch = 1;
  synth.speak(utterance);
  reading = true;
  readerBtn.classList.add('active');
  readerBtn.title = 'Desativar leitor de texto';
  readerBtn.setAttribute('aria-label', 'Desativar leitor de texto');
}

function stopReading() {
  synth.cancel();
  reading = false;
  readerBtn.classList.remove('active');
  readerBtn.title = 'Ativar leitor de texto';
  readerBtn.setAttribute('aria-label', 'Ativar leitor de texto');
}

readerBtn.addEventListener('click', () => {
  if (!reading) {
    startReading();
  } else {
    stopReading();
  }
});

// se o usu√°rio fechar o navegador ou trocar de aba
window.addEventListener('beforeunload', () => synth.cancel());

// feedback visual quando ativo
const style = document.createElement('style');
style.textContent = `
  #toggleReader.active {
    color: var(--accent);
    transform: scale(1.2);
  }
`;
document.head.appendChild(style);

  const contrastBtn = document.getElementById('toggleContrast');
let usingContrast = localStorage.getItem('flexspace_contrast') === 'true';

function applyContrast(){
  if(usingContrast){
    document.body.classList.add('high-contrast');
  } else {
    document.body.classList.remove('high-contrast');
  }
  localStorage.setItem('flexspace_contrast', usingContrast);
}

contrastBtn.addEventListener('click', ()=>{
  usingContrast = !usingContrast;
  applyContrast();
});

applyContrast();


</script>

  <!-- ===== FLEXAI v3.0 ‚Äî Assistente Avan√ßada (COLAR SUBSTITUINDO O BLOCO ANTIGO) ===== -->
<!-- HTML -->
<div id="flexai-root-v3" aria-live="polite">
  <button id="flexai-toggle-v3" class="flexai-btn-v3" aria-haspopup="dialog" aria-expanded="false" aria-label="Abrir FlexAI">ü§ñ</button>

  <aside id="flexai-panel-v3" class="flexai-panel-v3" role="dialog" aria-label="Assistente FlexAI" aria-hidden="true">
    <header class="flexai-header-v3" role="banner">
      <div class="flexai-left">
        <strong id="flexai-title">FlexAI</strong>
        <div class="small muted" id="flexai-sub">Assistente Pessoal</div>
      </div>
      <div class="flexai-controls">
        <select id="flexai-mode" aria-label="Modo de personalidade" title="Modo de personalidade">
          <option value="friendly">Amiga</option>
          <option value="pro">Profissional</option>
          <option value="coach">Coach</option>
          <option value="fun">Engra√ßadona</option>
        </select>
        <button id="flexai-voice-btn" title="Ativar reconhecimento de voz" aria-pressed="false">üéôÔ∏è</button>
        <button id="flexai-sound-btn" title="Ativar leitura autom√°tica" aria-pressed="false">üîä</button>
        <button id="flexai-close-v3" aria-label="Fechar">‚úñ</button>
      </div>
    </header>

    <main id="flexai-body-v3" class="flexai-body-v3" tabindex="0" role="region" aria-live="polite"></main>

    <form id="flexai-form-v3" class="flexai-input-v3" role="search" aria-label="Enviar mensagem para FlexAI">
      <input id="flexai-input-v3" placeholder="Pergunte algo (ex: 'Agendar demo para ter√ßa 10h')"
             aria-label="Mensagem para FlexAI" autocomplete="off" />
      <button id="flexai-send-v3" type="submit" aria-label="Enviar">‚û§</button>
    </form>

    <div class="flexai-actions-v3" role="toolbar" aria-label="A√ß√µes r√°pidas">
      <button data-act="tasks" title="Abrir lista de tarefas">‚ûï Tarefas</button>
      <button data-act="schedule" title="Agendar demo">üìÖ Agendar</button>
      <button data-act="rephrase" title="Reformular texto">üìù Reformular</button>
      <button data-act="study" title="Ajuda para estudar">üìö Estudo</button>
      <button data-act="prod" title="Plano de produtividade">‚è±Ô∏è Produtividade</button>
      <button data-act="readpage" title="Ler p√°gina">üîä Ler p√°gina</button>
      <button data-act="summary" title="Resumir conversa">‚úÇÔ∏è Resumir</button>
      <button data-act="export" title="Exportar hist√≥rico">‚¨áÔ∏è Exportar</button>
    </div>

    <div id="flexai-mini-overlay" aria-hidden="true"></div>
  </aside>
</div>

<!-- CSS -->
<style>
/* FLEXAI v3.0 - minimal, uses your CSS variables */
#flexai-root-v3 { position: fixed; right: 20px; bottom: 18px; z-index: 1400; font-family: Inter, sans-serif; }
.flexai-btn-v3 {
  width:64px; height:64px; border-radius:50%; border:0;
  background: linear-gradient(135deg,var(--brand),var(--accent)); color:#fff;
  box-shadow: 0 12px 30px rgba(2,10,12,0.25); font-size:28px; cursor:pointer;
}
.flexai-panel-v3 {
  width:380px; max-width:94vw; display:flex; flex-direction:column; border-radius:14px;
  overflow:hidden; box-shadow: 0 26px 60px rgba(2,6,12,0.3); background:var(--card);
  transition: transform .2s ease, opacity .2s ease;
}
.flexai-header-v3 { display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
  background: linear-gradient(90deg,var(--brand),var(--accent)); color:#fff;
}
.flexai-left strong { font-size:1.05rem; }
.flexai-body-v3 { padding:12px; max-height:360px; overflow:auto; display:flex; flex-direction:column; gap:8px; background:var(--bg); }
.flexai-input-v3 { display:flex; gap:8px; padding:10px; border-top:1px solid rgba(0,0,0,0.06); background:var(--card); }
.flexai-input-v3 input { flex:1; padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); }
.flexai-input-v3 button { background:var(--brand); color:#fff; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; }
.bot-msg-v3, .user-msg-v3, .system-msg-v3 { max-width:85%; padding:10px 12px; border-radius:12px; line-height:1.35; word-break:break-word; }
.bot-msg-v3 { background:var(--glass); align-self:flex-start; }
.user-msg-v3 { background:var(--brand); color:#fff; align-self:flex-end; }
.system-msg-v3 { background:rgba(0,0,0,0.05); align-self:center; font-size:.9rem; color:var(--muted); }
.typing-v3 { font-style:italic; opacity:.7; padding:8px 10px; border-radius:10px; background:var(--glass); align-self:flex-start;}
.flexai-actions-v3 { display:flex; gap:6px; padding:10px; flex-wrap:wrap; border-top:1px solid rgba(0,0,0,0.04); background:transparent; }
.flexai-actions-v3 button { padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); background:transparent; cursor:pointer; }
#flexai-mini-overlay { position:absolute; inset:0; pointer-events:none; display:none; }

/* small screens */
@media (max-width:520px){
  .flexai-panel-v3 { width:92vw; right:4vw; bottom:84px; border-radius:12px; }
  .flexai-btn-v3 { right:14px; bottom:14px; }
}
</style>

<!-- JS -->
<script>
/* ===== FLEXAI v3.0 ‚Äî Master Script (cole substituindo bloco antigo) ===== */
(function(){
  /* ----- Config & Storage Keys ----- */
  const ROOT = document.getElementById('flexai-root-v3');
  const TOGGLE = document.getElementById('flexai-toggle-v3');
  const PANEL = document.getElementById('flexai-panel-v3');
  const BODY = document.getElementById('flexai-body-v3');
  const FORM = document.getElementById('flexai-form-v3');
  const INPUT = document.getElementById('flexai-input-v3');
  const SEND = document.getElementById('flexai-send-v3');
  const CLOSE = document.getElementById('flexai-close-v3');
  const MODE = document.getElementById('flexai-mode');
  const VOICE_BTN = document.getElementById('flexai-voice-btn');
  const SOUND_BTN = document.getElementById('flexai-sound-btn');
  const ACTIONS = document.querySelector('.flexai-actions-v3');
  const OVERLAY = document.getElementById('flexai-mini-overlay');

  const STORAGE_KEY = 'flexai_v3_state_v1';

  /* state */
  let state = {
    history: [], // {role:'user'|'assistant'|'system', text, ts}
    tasks: [], // {id, text, done}
    appointments: [], // {id, text, datetime}
    mode: localStorage.getItem('flexai_mode') || 'friendly',
    voice: false,
    sound: false
  };

  /* restore state */
  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if(s && typeof s === 'object'){
      state = Object.assign(state, s);
    }
  } catch(e){ console.warn('flexai v3 restore error', e); }

  /* utilities */
  const now = () => new Date().toISOString();
  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);

  function appendSystem(text){ state.history.push({role:'system', text, ts: now()}); save(); renderMessage({role:'system', text}); }
  function appendUser(text){ state.history.push({role:'user', text, ts: now()}); save(); renderMessage({role:'user', text}); }
  function appendBot(text, html=null){ state.history.push({role:'assistant', text, ts: now()}); save(); renderMessage({role:'assistant', text, html}); if(state.sound) speak(text); }

  function renderMessage(msg){
    // msg: {role, text, html?}
    const el = document.createElement('div');
    if(msg.role === 'user') { el.className = 'user-msg-v3'; el.textContent = msg.text; }
    else if(msg.role === 'assistant') { el.className = 'bot-msg-v3'; el.innerHTML = msg.html || escapeHtml(msg.text); el.tabIndex = 0; el.addEventListener('click', ()=> speak(msg.text)); }
    else { el.className = 'system-msg-v3'; el.textContent = msg.text; }
    BODY.appendChild(el);
    BODY.scrollTop = BODY.scrollHeight;
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  /* initial render of history */
  function renderAll(){
    BODY.innerHTML = '';
    (state.history || []).forEach(m => renderMessage(m));
  }

  /* typing indicator */
  function showTyping(){ const t = document.createElement('div'); t.className = 'typing-v3'; t.id = 'flexai-typing-v3'; t.textContent = 'FlexAI est√° digitando...'; BODY.appendChild(t); BODY.scrollTop = BODY.scrollHeight; }
  function hideTyping(){ document.getElementById('flexai-typing-v3')?.remove(); }

  /* personality templates */
  const PERSONALITY = {
    friendly: {
      greet: ['Oi! üòä', 'E a√≠! Como posso ajudar hoje?'],
      fallback: ['Poxa, n√£o entendi bem ‚Äî pode explicar diferente?', 'Hmm, posso ajudar com agendar, reformular ou criar tarefas. Quer tentar uma?'],
      praise: ['Boa! Mandou bem üòâ', '√ìtimo trabalho!']
    },
    pro: {
      greet: ['Ol√°. Em que posso ser √∫til hoje?', 'Como posso apoiar suas atividades?'],
      fallback: ['N√£o consegui interpretar ‚Äî poderia detalhar mais?', 'Posso agendar, gerar resumo ou criar tarefas. Deseja alguma dessas?'],
      praise: ['Recebido. Excelente trabalho.', 'Sinalizado como conclu√≠do.']
    },
    coach: {
      greet: ['Vamos focar ‚Äî o que voc√™ quer conquistar hoje?', 'Qual √© o objetivo principal de hoje?'],
      fallback: ['Vamos decompor isso em passos, quer que eu comece?', 'Ok ‚Äî quer uma sugest√£o de plano de a√ß√£o?'],
      praise: ['Perfeito, continue assim!', 'Isso mostra progresso ‚Äî mantenha o ritmo.']
    },
    fun: {
      greet: ['Opa! Preparadx pra zoeira produtiva? üòÇ', 'Fala a√≠, chefia do coworking!'],
      fallback: ['Que pergunta enigm√°tica! Quer que eu responda com meme?', 'N√£o peguei a vibe ‚Äî tenta me explicar com outra frase.'],
      praise: ['Arrasou! üåü', 'Topzera!']
    }
  };

  function personalityPick(key){
    const arr = PERSONALITY[state.mode]?.[key] || PERSONALITY.friendly[key];
    return arr[Math.floor(Math.random()*arr.length)];
  }

  /* intent engine (rules) */
  function detectIntent(text){
    const t = text.toLowerCase();
    if(/^(oi|ol√°|ola|opa|bom dia|boa tarde|boa noite)\b/.test(t)) return {intent:'greet'};
    if(/\b(agendar|agenda|marcar|reservar)\b/.test(t)) return {intent:'schedule'};
    if(/\b(tarefa|tarefas|to ?do|lista)\b/.test(t)) return {intent:'tasks'};
    if(/\b(reformular|reescrever|melhorar texto|corrigir)\b/.test(t)) return {intent:'rephrase'};
    if(/\b(estudo|resumo|resumir|quest√µes|questao|pergunta|prova|exerc√≠cio|exercicio)\b/.test(t)) return {intent:'study'};
    if(/\b(produtividade|pomodoro|foco|organiza|organizar)\b/.test(t)) return {intent:'productivity'};
    if(/\b(clima|equipe|humor|mood)\b/.test(t)) return {intent:'climate'};
    if(/\b(ler pagina|ler p√°gina|ler p√°gina|ler pagina|ler|read page)\b/.test(t)) return {intent:'readpage'};
    if(/\b(resumir conversa|resumir|sumario|resumo)\b/.test(t)) return {intent:'summary'};
    if(/\b(exportar|baixar|export)\b/.test(t)) return {intent:'export'};
    if(/\b(qq|o que|como|por que|porque|por qu√™)\b/.test(t)) return {intent:'ask'};
    // fallback = chat
    return {intent:'chat'};
  }

  /* complex response generator */
  async function handleText(text){
    const it = detectIntent(text);
    if(it.intent === 'greet'){ appendBot(personalityPick('greet')); return; }
    if(it.intent === 'schedule'){ openSchedulerPrompt(text); return; }
    if(it.intent === 'tasks'){ openTasksUI(); return; }
    if(it.intent === 'rephrase'){ openRephraseFlow(text); return; }
    if(it.intent === 'study'){ openStudyFlow(text); return; }
    if(it.intent === 'productivity'){ openProductivityFlow(text); return; }
    if(it.intent === 'climate'){ simulateClimate(text); return; }
    if(it.intent === 'readpage'){ readEntirePage(); return; }
    if(it.intent === 'summary'){ const s = generateLocalSummary(); appendBot(s); return; }
    if(it.intent === 'export'){ exportHistory(); return; }
    if(it.intent === 'chat'){ // more advanced local reasoning + varied responses
      // quick checks for sentiment-like words
      if(/\b(estou|me sinto|sinto)\b.*\b(triste|cansad|estressad|deprimid)/.test(text.toLowerCase())){
        appendBot(personalityPick('fallback') + ' ' + choose(['Se quiser, posso sugerir um plano de descanso simples.','Quer falar mais sobre isso?']));
        return;
      }
      // if text contains a paragraph request (e.g., reformulate)
      appendBot(choose([
        'Interessante ‚Äî quer que eu: (1) agende, (2) gere um resumo, (3) crie tarefas relacionadas? Responda 1,2 ou 3.',
        'Ok ‚Äî posso ajudar com agendamento, reformula√ß√£o, tarefas ou an√°lise. Qual prefere?',
        'Boa pergunta! Posso simular um agendamento, criar um checklist ou reformular um texto. O que prefere?'
      ]));
      return;
    }
  }

  /* small chooser */
  function choose(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  /* ====== Features implementations ====== */

  /* Tasks UI (inline modal-like in the chat) */
  function openTasksUI(){
    showTyping();
    setTimeout(()=> {
      hideTyping();
      const idBase = uid('tasks');
      const html = `
        <div class="system-msg-v3">Gerenciador de Tarefas</div>
        <div style="display:flex;gap:8px;flex-direction:column">
          <input id="${idBase}_newtask" placeholder="Nova tarefa..." style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"/>
          <div style="display:flex;gap:8px">
            <button id="${idBase}_add" style="padding:6px 8px;border-radius:8px">Adicionar</button>
            <button id="${idBase}_list" style="padding:6px 8px;border-radius:8px">Mostrar tarefas</button>
            <button id="${idBase}_clear" style="padding:6px 8px;border-radius:8px">Limpar conclu√≠das</button>
          </div>
          <div id="${idBase}_container" style="margin-top:8px"></div>
        </div>
      `;
      appendBot(html, html);
      // attach handlers after render
      setTimeout(()=>{
        const addBtn = document.getElementById(`${idBase}_add`);
        const newInp = document.getElementById(`${idBase}_newtask`);
        const listBtn = document.getElementById(`${idBase}_list`);
        const clearBtn = document.getElementById(`${idBase}_clear`);
        const container = document.getElementById(`${idBase}_container`);

        function renderTasks(){
          container.innerHTML = '';
          if(state.tasks.length===0) container.innerHTML = '<div class="system-msg-v3">Sem tarefas</div>';
          state.tasks.forEach(t => {
            const row = document.createElement('div');
            row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='6px';
            row.innerHTML = `<input type="checkbox" ${t.done?'checked':''} data-id="${t.id}" class="flexai-taskchk"/><div style="flex:1">${escapeHtml(t.text)}</div><button data-id="${t.id}" class="flexai-taskdel">‚úñ</button>`;
            container.appendChild(row);
          });
          // bind
          container.querySelectorAll('.flexai-taskchk').forEach(cb => cb.addEventListener('change', (e)=> {
            const id = e.target.dataset.id; const t = state.tasks.find(x=>x.id===id); if(t){ t.done = e.target.checked; save(); }
          }));
          container.querySelectorAll('.flexai-taskdel').forEach(btn => btn.addEventListener('click', (e)=> {
            const id = e.target.dataset.id; state.tasks = state.tasks.filter(x=>x.id!==id); save(); renderTasks();
          }));
        }

        addBtn.addEventListener('click', ()=>{
          const v = newInp.value.trim(); if(!v) return;
          state.tasks.push({id: uid('t'), text: v, done: false}); newInp.value=''; save(); renderTasks();
        });
        listBtn.addEventListener('click', ()=> renderTasks());
        clearBtn.addEventListener('click', ()=> { state.tasks = state.tasks.filter(t=>!t.done); save(); renderTasks(); });
        renderTasks();
      }, 80);
    }, 500);
  }

  /* Scheduler prompt (simula√ß√£o) */
  function openSchedulerPrompt(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('sched');
      const html = `
        <div class="system-msg-v3">Agendamento (simula√ß√£o)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="${idBase}_when" placeholder="Data e hora (ex: 2025-12-01 14:00)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"/>
          <input id="${idBase}_what" placeholder="Motivo (ex: Demo FlexSpace)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"/>
          <div style="display:flex;gap:8px">
            <button id="${idBase}_ok" style="padding:6px 8px;border-radius:8px">Agendar</button>
            <button id="${idBase}_cancel" style="padding:6px 8px;border-radius:8px">Cancelar</button>
          </div>
        </div>
      `;
      appendBot(html, html);
      setTimeout(()=>{
        document.getElementById(`${idBase}_ok`).addEventListener('click', ()=>{
          const dt = document.getElementById(`${idBase}_when`).value.trim();
          const what = document.getElementById(`${idBase}_what`).value.trim() || 'Agendamento';
          if(!dt){ appendBot('Por favor informe data e hora no formato sugerido.'); return; }
          const ap = { id: uid('a'), text: what, datetime: dt };
          state.appointments.push(ap); save();
          appendBot(`Agendado (simulado): ${what} ‚Äî ${dt}`);
        });
        document.getElementById(`${idBase}_cancel`).addEventListener('click', ()=> appendBot('Agendamento cancelado.'));
      }, 80);
    }, 500);
  }

  /* Rephrase flow: basic rules-based */
  function openRephraseFlow(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('reph');
      const html = `
        <div class="system-msg-v3">Reformular texto</div>
        <textarea id="${idBase}_src" placeholder="Cole seu texto aqui..." style="width:100%;height:80px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"></textarea>
        <div style="display:flex;gap:8px">
          <button id="${idBase}_gent" style="padding:6px 8px;border-radius:8px">Gerar vers√£o formal</button>
          <button id="${idBase}_gent2" style="padding:6px 8px;border-radius:8px">Gerar vers√£o amig√°vel</button>
        </div>
        <div id="${idBase}_out" style="margin-top:8px"></div>
      `;
      appendBot(html, html);
      setTimeout(()=>{
        document.getElementById(`${idBase}_gent`).addEventListener('click', ()=>{
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole algo pra eu reformular.'); return; }
          // naive rules-based formalizer (simple)
          const res = s.replace(/\bvc\b/gi,'voc√™').replace(/\btbj\b/gi,'tamb√©m').replace(/\bq\b/gi,'que');
          const out = `Vers√£o formal: ${res.charAt(0).toUpperCase()+res.slice(1)}`;
          document.getElementById(`${idBase}_out`).innerText = out;
          appendBot(out);
        });
        document.getElementById(`${idBase}_gent2`).addEventListener('click', ()=>{
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole algo pra eu reformular.'); return; }
          const out = `Vers√£o amig√°vel: ${s}. Achei legal, s√≥ ajustar uns detalhes :)`;
          document.getElementById(`${idBase}_out`).innerText = out;
          appendBot(out);
        });
      }, 80);
    }, 500);
  }

  /* Study flow: quick summary + quiz generation */
  function openStudyFlow(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('study');
      const html = `
        <div class="system-msg-v3">Estudo ‚Äî Resumo e Quiz</div>
        <textarea id="${idBase}_src" placeholder="Cole texto para resumo" style="width:100%;height:100px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"></textarea>
        <div style="display:flex;gap:8px">
          <button id="${idBase}_summary" style="padding:6px 8px;border-radius:8px">Gerar resumo</button>
          <button id="${idBase}_quiz" style="padding:6px 8px;border-radius:8px">Gerar quiz (3 perguntas)</button>
        </div>
        <div id="${idBase}_out" style="margin-top:8px"></div>
      `;
      appendBot(html, html);
      setTimeout(()=>{
        document.getElementById(`${idBase}_summary`).addEventListener('click', ()=>{
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole um texto para eu resumir.'); return; }
          // super simple summarizer: pick top sentences by length and keywords
          const sentences = s.split(/[.?!]\s+/).filter(Boolean);
          const top = sentences.slice(0, Math.min(3, sentences.length)).join('. ') + (sentences.length>3? '‚Ä¶':'');
          const res = `Resumo curto: ${top}`;
          document.getElementById(`${idBase}_out`).innerText = res;
          appendBot(res);
        });
        document.getElementById(`${idBase}_quiz`).addEventListener('click', ()=>{
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole um texto para eu gerar perguntas.'); return; }
          const sentences = s.split(/[.?!]\s+/).filter(Boolean);
          const q = sentences.slice(0,3).map((sen,i)=> `Pergunta ${i+1}: Sobre "${sen.slice(0,40)}..." ‚Äî responda em 1 frase.`).join('\n');
          document.getElementById(`${idBase}_out`).innerText = q;
          appendBot(q);
        });
      }, 80);
    }, 600);
  }

  /* productivity flow: pomodoro suggestion */
  function openProductivityFlow(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('prod');
      const html = `
        <div class="system-msg-v3">Produtividade ‚Äî Mini-Pomodoro</div>
        <div style="display:flex;gap:8px;flex-direction:column">
          <label>Tempo trabalho (min): <input id="${idBase}_work" value="25" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)"/></label>
          <label>Tempo pausa (min): <input id="${idBase}_break" value="5" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)"/></label>
          <div style="display:flex;gap:8px"><button id="${idBase}_start">Iniciar Pomodoro</button><button id="${idBase}_stop">Parar</button></div>
          <div id="${idBase}_status" style="margin-top:8px"></div>
        </div>
      `;
      appendBot(html, html);
      setTimeout(()=>{
        let timer = null; let remaining=0; let mode='work';
        const status = document.getElementById(`${idBase}_status`);
        function tick(){
          if(remaining<=0){
            if(mode==='work'){ mode='break'; remaining = parseInt(document.getElementById(`${idBase}_break`).value || 5)*60; appendBot('Pausa! Agora descanso curto.'); }
            else { mode='work'; remaining = parseInt(document.getElementById(`${idBase}_work`).value || 25)*60; appendBot('Volta ao trabalho!'); }
          }
          remaining--; const mm = Math.floor(remaining/60); const ss = remaining%60;
          status.innerText = `${mode.toUpperCase()}: ${mm}:${ss.toString().padStart(2,'0')}`;
        }
        document.getElementById(`${idBase}_start`).addEventListener('click', ()=>{
          remaining = parseInt(document.getElementById(`${idBase}_work`).value || 25)*60;
          if(timer) clearInterval(timer);
          timer = setInterval(tick, 1000);
          appendBot('Pomodoro iniciado. Boa produtividade!');
        });
        document.getElementById(`${idBase}_stop`).addEventListener('click', ()=>{
          if(timer) clearInterval(timer); timer = null; status.innerText = 'Parado';
          appendBot('Pomodoro parado.');
        });
      },80);
    },500);
  }

  /* simulate climate: simple mock */
  function simulateClimate(text){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const res = choose([
        'Clima da equipe: est√°vel ‚Äî sugiro uma reuni√£o r√°pida de alinhamento.',
        'Clima: algumas tens√µes detectadas (mensagens recentes). Talvez feedback 1:1 ajude.',
        'Clima: positivo! Continue com reconhecimento de pequenos resultados.'
      ]);
      appendBot(res);
    }, 600);
  }

  /* read entire page */
  function readEntirePage(){
    const raw = document.body.innerText || document.documentElement.innerText;
    const cleaned = raw.replace(/\s+/g,' ').slice(0,2000);
    appendBot('Lendo a p√°gina... (m√°x 2000 chars)'); speak(cleaned);
  }

  /* generate local summary of conversation */
  function generateLocalSummary(){
    const last = state.history.slice(-10).map(h => `${h.role === 'user' ? 'User' : (h.role==='assistant'?'AI':'Sys')}: ${h.text}`).join(' ‚Ä¢ ');
    return `Resumo (√∫ltimas mensagens): ${last || 'nenhuma mensagem'}`;
  }

  /* export history */
  function exportHistory(){
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'flexai_history.json'; a.click();
    URL.revokeObjectURL(url);
    appendBot('Hist√≥rico exportado (download iniciado).');
  }

  /* speech: TTS */
  function speak(text){
    try {
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch(e){ console.warn('speak fail', e); }
  }

  /* speech: STT */
  let recognition = null;
  try {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR) { recognition = new SR(); recognition.lang = 'pt-BR'; recognition.interimResults = false; }
  } catch(e){ recognition = null; }

  if(VOICE_BTN){
    VOICE_BTN.addEventListener('click', ()=>{
      if(!recognition){ appendBot('Reconhecimento de voz n√£o suportado neste navegador.'); return; }
      try {
        recognition.start();
        appendBot('üéôÔ∏è Estou ouvindo ‚Äî fale agora.');
      } catch(e){ console.warn(e); }
    });
    if(recognition){
      recognition.onresult = (ev) =>{
        const speech = ev.results[0][0].transcript;
        INPUT.value = speech;
        appendUser(speech);
        // small delay to simulate thinking
        showTyping();
        setTimeout(()=>{ hideTyping(); handleText(speech); }, 600);
      };
      recognition.onerror = (e)=> appendBot('Erro de reconhecimento de voz: ' + (e.error||e.message));
    }
  }

  /* send flow */
  FORM.addEventListener('submit', (ev)=> {
    ev.preventDefault();
    const txt = INPUT.value.trim();
    if(!txt) return;
    INPUT.value = '';
    appendUser(txt);
    showTyping();
    setTimeout(()=> { hideTyping(); handleText(txt); }, 400);
  });

  /* quick actions */
  ACTIONS.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    if(act === 'tasks') openTasksUI();
    else if(act === 'schedule') openSchedulerPrompt();
    else if(act === 'rephrase') openRephraseFlow();
    else if(act === 'study') openStudyFlow();
    else if(act === 'prod') openProductivityFlow();
    else if(act === 'readpage') readEntirePage();
    else if(act === 'summary') appendBot(generateLocalSummary());
    else if(act === 'export') exportHistory();
  });

  /* panel open/close */
  TOGGLE.addEventListener('click', ()=> {
    PANEL.style.display = 'flex';
    PANEL.setAttribute('aria-hidden','false');
    TOGGLE.style.display = 'none';
    INPUT.focus();
  });
  CLOSE.addEventListener('click', ()=> {
    PANEL.style.display = 'none';
    PANEL.setAttribute('aria-hidden','true');
    TOGGLE.style.display = 'inline-block';
  });

  /* mode switch */
  MODE.value = state.mode || 'friendly';
  MODE.addEventListener('change', ()=> { state.mode = MODE.value; localStorage.setItem('flexai_mode', state.mode); appendSystem('Modo: ' + state.mode); });

  /* sound toggle */
  SOUND_BTN.addEventListener('click', ()=> {
    state.sound = !state.sound; SOUND_BTN.setAttribute('aria-pressed', state.sound ? 'true' : 'false'); save();
    appendSystem('Leitura autom√°tica ' + (state.sound ? 'ativada' : 'desativada'));
  });

  /* open tasks when user hovers cards (integration) */
  document.querySelectorAll('.card').forEach(card=>{
    card.addEventListener('mouseenter', ()=>{
      const title = card.querySelector('.card-title')?.innerText || 'um espa√ßo';
      // brief assistive hint
      OVERLAY.style.display = 'block';
      OVERLAY.textContent = `Dica da FlexAI: quer informa√ß√µes sobre "${title}"? Pergunte-me!`;
      setTimeout(()=> OVERLAY.style.display = 'none', 2200);
      // optional: read
      if(state.sound) speak(`Voc√™ passou por ${title}`);
    });
  });

  /* small helpers: load previous history on startup */
  renderAll();
  if(state.history.length===0) appendBot(personalityPick('greet'));

  /* expose for debugging */
  window.FlexAIv3 = {
    state,
    open: ()=> { TOGGLE.click(); },
    close: ()=> { CLOSE.click(); },
    speak,
    save
  };

  /* save on unload */
  window.addEventListener('beforeunload', save);

})();

</script>
</body>
</html>

