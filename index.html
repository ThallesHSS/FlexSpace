<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FlexSpace ‚Äî Demo Corporativa</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f5fefd;
    --card: #ffffff;
    --muted: #6b7a80;
    --brand: #2bc3cc;
    --accent: #32ebc0;
    --text: #053f4e;
    --glass: rgba(255,255,255,0.6);
    --shadow: 0 8px 24px rgba(6,20,25,0.08);
    --radius: 14px;
    --soft-radius: 10px;
    --transition: 250ms cubic-bezier(.2,.9,.3,1);
  }

  .dark {
    --bg: #0f1720;
    --card: #0b1220;
    --muted: #9aa7b0;
    --brand: #6a9bd6;
    --accent: #7fd3d1;
    --text: #e6f0f3;
    --glass: rgba(255,255,255,0.03);
    --shadow: 0 10px 30px rgba(2,6,12,0.6);
  }

  .high-contrast {
    --bg: #000000;
    --card: #000000;
    --muted: #ffffff;
    --brand: #ffff00;
    --accent: #00ffff;
    --text: #ffffff;
    --glass: rgba(255,255,255,0.15);
    --shadow: none;
  }

  .high-contrast a,
  .high-contrast button,
  .high-contrast select,
  .high-contrast input {
    border: 2px solid #ffffff !important;
    color: #ffffff !important;
    background: #000000 !important;
  }

  .high-contrast .btn.primary {
    background: #ffff00 !important;
    color: #000000 !important;
  }

  .high-contrast .logo {
    background: linear-gradient(135deg, #ffff00, #00ffff) !important;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,var(--bg), #eafefefd 120%);
    color:var(--text);
    margin:0; -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color:transparent;
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:60;
    backdrop-filter: blur(6px);
    background: linear-gradient(90deg, rgba(255,255,255,0.55), rgba(255,255,255,0.35));
    border-bottom: 1px solid rgba(0,0,0,0.04);
    padding:12px 20px; display:flex; align-items:center; justify-content:space-between;
  }
  .dark header{
    background: linear-gradient(90deg, rgba(10,14,20,0.6), rgba(10,14,20,0.4));
    border-bottom-color: rgba(255,255,255,0.03);
  }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background:linear-gradient(135deg,var(--brand),var(--accent));
    box-shadow: var(--shadow);
    display:grid; place-items:center; color:#fff; font-weight:700;
  }
  .brand h1{font-size:1rem;margin:0}
  nav.topnav{display:flex; gap:18px; align-items:center;}
  nav.topnav a{color:var(--text); text-decoration:none; font-weight:600; opacity:.95; font-size:.95rem}
  nav.topnav a:hover{opacity:1; transform:translateY(-2px)}
  .controls{display:flex; gap:10px; align-items:center}
  button.icon-btn{
    border:0; background:transparent; padding:8px; border-radius:10px; cursor:pointer;
    display:inline-grid; place-items:center; transition:all var(--transition);
  }
  button.icon-btn:hover{transform:translateY(-3px)}

  /* Layout */
  main{max-width:1100px;margin:24px auto;padding:0 20px;}
  .hero{
    display:grid; grid-template-columns: 1fr 420px; gap:28px; align-items:center;
    margin-bottom:28px;
  }
  .hero-card{
    background:var(--card); border-radius:var(--radius); padding:28px;
    box-shadow:var(--shadow); transition:transform var(--transition);
  }
  .hero-card h2{margin:0 0 8px;font-size:1.6rem;letter-spacing:-0.2px}
  .hero-card p{color:var(--muted); margin:0 0 18px}
  .hero-actions{display:flex; gap:12px; margin-top:10px}
  .btn{padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--brand); color:#fff; box-shadow: 0 8px 18px rgba(43,195,204,0.18)}
  .btn.ghost{background:transparent; border:1px solid rgba(0,0,0,0.06)}

  .hero-visual{
    border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
    height:260px; background-size:cover; background-position:center;
  }

  /* Search & filter */
  .searchbar{display:flex; gap:12px; margin-top:14px; align-items:center}
  .searchbar input{
    flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);
    background:var(--glass); color:var(--text);
  }
  .searchbar select{
    padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);
    background:var(--card); color:var(--text);
  }

  /* Grid cards */
  .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:18px; margin-top:18px;}
  .card{
    background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    display:flex; flex-direction:column; transition:transform var(--transition), box-shadow var(--transition);
    min-height:320px;
  }
  .card:hover{transform:translateY(-8px); box-shadow: 0 22px 40px rgba(6,20,25,0.12)}
  .card-media{height:150px; background-size:cover; background-position:center}
  .card-body{padding:14px 16px; display:flex; flex-direction:column; gap:10px; flex:1}
  .card-title{font-weight:700; font-size:1.05rem}
  .card-desc{color:var(--muted); font-size:0.95rem; flex:1}
  .card-footer{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .card-actions{display:flex; gap:8px; align-items:center}

  /* rating */
  .stars{display:flex; gap:6px; align-items:center}
  .star{
    font-size:20px; color: #cbd5d9; cursor:pointer; transition: color 180ms;
    text-shadow: 0 1px 0 rgba(0,0,0,0.06);
    user-select:none;
  }
  .star.on{ color: #ffd65a; }
  .rating-count{color:var(--muted); font-size:0.85rem}

  /* overlay quick */
  .overlay-trigger{position:absolute; inset:12px; border-radius:12px; pointer-events:none}
  .card .card-overlay{
    position:absolute; right:12px; top:12px; background:rgba(0,0,0,0.05); padding:6px;border-radius:10px; pointer-events:auto;
  }

  /* footer */
  footer.site-footer{margin:36px auto 80px; text-align:center; color:var(--muted); font-size:0.95rem}

  /* responsive */
  @media (max-width:980px){
    .hero{grid-template-columns:1fr; gap:16px}
    .grid{grid-template-columns:repeat(2,1fr)}
    .hero-visual{height:200px}
  }
  @media (max-width:620px){
    header{padding:12px}
    nav.topnav{display:none}
    .grid{grid-template-columns:1fr}
    .hero-visual{height:160px}
    .hero-card{padding:18px}
  }

  .muted{color:var(--muted)}
  .small{font-size:.85rem}
  a.btn-link{color:var(--brand); text-decoration:none; font-weight:600}
  .star:focus, .icon-btn:focus, .btn:focus, input:focus, select:focus{outline:3px solid rgba(43,195,204,0.14); outline-offset:2px}
</style>
</head>
<body>

<header role="banner" aria-label="Cabe√ßalho do site">
  <div class="brand">
    <div class="logo" aria-hidden="true"><img src="https://thalleshss.github.io/FlexSpace/Logo%20flexspace.jfif" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:10px"></div>
    <div>
      <h1 style="font-size:0.95rem;margin:0">FlexSpace</h1>
      <div class="small muted">Demonstra√ß√£o Corporativa</div>
    </div>
  </div>

  <nav class="topnav" role="navigation" aria-label="Menu principal">
    <a href="#sobre">Perfil</a>
    <a href="#espacos">Minha Empresa</a>
    <a href="#contato">Configura√ß√µes</a>
  </nav>

 <div class="controls" aria-hidden="false">
  <button class="icon-btn" id="toggleTheme" title="Alternar tema (lido pelo leitor)" aria-pressed="false">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="currentColor"/>
    </svg>
  </button>

  <button class="icon-btn" id="toggleReader" title="Ativar leitor de texto" aria-label="Ativar leitor de texto">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M3 10v4a1 1 0 001 1h2l3 3V6L6 9H4a1 1 0 00-1 1zm13.54-3.54a5 5 0 010 7.07m2.83-9.9a9 9 0 010 12.73"
        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <button class="icon-btn" title="Ajuda" aria-label="Ajuda">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM11 17h2v-2h-2v2zm2.07-7.75a2 2 0 10-3.14 1.76"
        stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

   <button class="icon-btn" id="toggleContrast" title="Ativar alto contraste" aria-label="Ativar alto contraste">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
    <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 6v12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
  </svg>
</button>
</div>
</header>

<main>
  <section class="hero" aria-labelledby="hero-title">
    <div class="hero-card" role="region" aria-label="Informa√ß√µes sobre a demonstra√ß√£o">
      <h2 id="hero-title">Demonstra√ß√£o FlexSpace ‚Äî Contabilidade XYZ</h2>
      <p>Gerencie, visualize e avalie os espa√ßos da sua empresa. Clique em um espa√ßo para ver op√ß√µes, ou avalie com estrelas.</p>

      <div class="searchbar" role="search">
        <input id="searchInput" placeholder="Procurar espa√ßo (ex: Sala de reuni√£o, Banheiro...)" aria-label="Procurar espa√ßos">
        <select id="filterSelect" aria-label="Filtrar por tipo">
          <option value="">Todos os tipos</option>
        </select>
        <button class="btn primary" id="newDemoBtn">Agendar Demo</button>
      </div>

      <div style="margin-top:14px; display:flex; gap:12px; align-items:center;">
        <div class="muted small">Exibindo <strong id="visibleCount">0</strong> espa√ßos</div>
        <div style="flex:1"></div>
        <a href="#espacos" class="btn ghost">Ver espa√ßos</a>
      </div>
    </div>

    <div class="hero-visual" role="img" aria-label="Imagem de ambiente corporativo" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZQ6JzKX9La8o_2GV68nfg5YB9cI9DaAyhbw&s');"></div>
  </section>

  <section id="espacos" class="section" aria-labelledby="espacos-title">
    <h3 id="espacos-title" style="margin:0 0 8px">Espa√ßos Dispon√≠veis</h3>
    <p class="muted small" style="margin-top:0">Passe o mouse (ou toque) nos cards para ver op√ß√µes r√°pidas. Avalie cada espa√ßo com as estrelas.</p>

    <div class="grid" id="cardsGrid" aria-live="polite">
      <!-- cards ser√£o inseridos por JS -->
    </div>
  </section>

  <section id="sobre" style="margin-top:30px; display:flex; gap:20px; align-items:flex-start;">
    <div style="flex:1" class="hero-card">
      <h4 style="margin-top:0">Sobre a Empresa</h4>
      <p class="muted">A Contabilidade XYZ utiliza a FlexSpace para gerenciar salas de reuni√µes, escrit√≥rios e √°reas comuns. Aqui √© s√≥ uma demonstra√ß√£o que mostra a interface e intera√ß√µes com os espa√ßos.</p>
      <p class="small muted">Este prot√≥tipo n√£o grava em servidor ‚Äî as avalia√ß√µes ficam salvas apenas no seu navegador.</p>
    </div>

    <div style="width:320px" class="hero-card">
      <h4 style="margin-top:0">Contato</h4>
      <p class="muted small">Demo / Suporte: <strong>demo@flexspace.com</strong></p>
      <p style="margin-top:12px"><a href="#" class="btn primary" style="width:100%;text-align:center">Solicitar apresenta√ß√£o</a></p>
    </div>
  </section>
</main>

<footer class="site-footer" role="contentinfo">
  FlexSpace ¬© <span id="year"></span> ‚Äî Esta √© uma demonstra√ß√£o corporativa. Layout inspirado em aplicativos e sites organizacionais.
</footer>

<script>
/* Data inicial dos espa√ßos */
const spaces = [
  { id: 'esp-1', type:'escritorio', title:'Escrit√≥rio Principal', desc:'Espa√ßo moderno para a equipe trabalhar de forma confort√°vel.', img:'https://www.divdesign.com.br/wp-content/uploads/2021/11/tendencias-moveis-escritorio-div-design.jpg' },
  { id: 'esp-2', type:'reuniao', title:'Sala de Reuni√£o', desc:'Sala equipada para apresenta√ß√µes e reuni√µes com clientes.', img:'https://funcional.wpcdn.com.br/blog/2023/05/FUNCIONAL_blog_16-05-1.png' },
  { id: 'esp-3', type:'banheiro', title:'Banheiros', desc:'Banheiros limpos e acess√≠veis para equipe e visitantes.', img:'https://s32907.pcdn.co/wp-content/uploads/2020/03/revestimento-de-banheiro-01032020.jpg' },
  { id: 'esp-4', type:'lazer', title:'√Årea Comum', desc:'Lounge e caf√© para pausas, networking e eventos internos.', img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMcmmlozZlIxAUweMOYjzeRhITuLolo-TrkA&s' },
  { id: 'esp-5', type:'escritorio', title:'Escrit√≥rio Financeiro', desc:'Ambiente reservado para equipe financeira e reuni√µes confidenciais.', img:'https://cdn.cobrefacil.com.br/website/base/650/c4c/a7b/departamento-financeiro.jpg' },
  { id: 'esp-6', type:'lazer', title:'Sala de Lazer', desc:'Sala grande e aconchegante para o descanso dos funcion√°rios.', img:'https://qtmov.com.br/blog/wp-content/uploads/2023/06/blog-O-que-nao-pode-faltar-em-uma-sala-de-descanso-na-empresa-qtmov.jpeg' },
  { id: 'esp-7', type:'reuniao', title:'Sala de Treinamento', desc:'Sala grande com projetor para treinamentos e workshops.', img:'https://images.unsplash.com/photo-1542744173-8e7e53415bb0?q=80&w=1200&auto=format&fit=crop' },
  { id: 'esp-8', type:'alimentacao', title:'Cantina', desc:'Cantina onde os funcion√°rios podem comprar seus lanches.', img:'https://img.freepik.com/fotos-premium/cantina-de-uma-empresa-start-up-moderna_260036-237.jpg' },
  { id: 'esp-9', type:'alimentacao', title:'Pra√ßa de alimenta√ß√£o', desc:'Local onde os funcion√°rios se alimentam e interagem entre s√≠.', img:'https://png.pngtree.com/png-clipart/20200701/original/pngtree-three-dimensional-company-canteen-png-image_5406368.jpg' },
];

/* Utils: rating persistence in localStorage */
const STORAGE_KEY = 'flexspace_ratings_v1';
function loadRatings(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){return {} } }
function saveRatings(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

/* Render cards */
const grid = document.getElementById('cardsGrid');
const visibleCount = document.getElementById('visibleCount');

function createCard(space, ratingState){
  const card = document.createElement('article');
  card.className = 'card';
  card.setAttribute('data-id', space.id);
  card.setAttribute('tabindex', '0');
  card.innerHTML = `
    <div class="card-media" style="background-image: url('${space.img}')"></div>
    <div class="card-body">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="flex:1">
          <div class="card-title">${space.title}</div>
          <div class="card-desc">${space.desc}</div>
        </div>
      </div>

      <div class="card-footer" style="margin-top:8px">
        <div>
          <div class="stars" role="radiogroup" aria-label="Avalia√ß√£o de ${space.title}">
            ${[1,2,3,4,5].map(i => `<span class="star" role="radio" tabindex="0" data-value="${i}" aria-checked="${(ratingState||0)===i? 'true':'false'}" title="${i} estrela">${i<= (ratingState||0) ? '&#9733;':'&#9733;'}</span>`).join('')}
          </div>
          <div class="rating-count small muted" style="margin-top:6px"><span class="rating-value">${ratingState||0}</span> ‚òÖ ‚Äî <span class="small muted">base: demo</span></div>
        </div>
        <div class="card-actions">
          <button class="btn" data-action="details" aria-label="Detalhes de ${space.title}">Detalhes</button>
          <button class="btn primary" data-action="book" aria-label="Agendar ${space.title}">Agendar</button>
        </div>
      </div>
    </div>
  `;
  attachStarHandlers(card, space.id);
  attachActionHandlers(card, space);
  return card;
}

/* Attach actions */
function attachActionHandlers(card, space){
  card.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const act = btn.getAttribute('data-action');
      if(act==='details'){
        const links = {
          'Escrit√≥rio Principal': 'https://thalleshss.github.io/FlexSpace/FlexDt/Detalhes%20escrit%C3%B3rio.html',
          'Sala de Reuni√£o': 'https://thalleshss.github.io/FlexSpace/FlexDt/Detalhes%20sala%20reuni%C3%A3o.html',
          'Banheiros': 'https://thalleshss.github.io/FlexSpace/FlexDt/Banheiros%20dt.html',
          '√Årea Comum': 'https://thalleshss.github.io/FlexSpace/FlexDt/Arc%20dt.html',
          'Escrit√≥rio Financeiro': 'https://thalleshss.github.io/FlexSpace/FlexDt/Escfndt.html',
          'Sala de Lazer': 'https://thalleshss.github.io/FlexSpace/FlexDt/sllzdt.html',
          'Sala de Treinamento': 'https://thalleshss.github.io/FlexSpace/FlexDt/strdt.html',
          'Cantina': 'https://thalleshss.github.io/FlexSpace/FlexDt/Ctdt.html',
          'Pra√ßa de alimenta√ß√£o': 'https://thalleshss.github.io/FlexSpace/FlexDt/padt.html'
        };

        const url = links[space.title];
        if(url){
          window.location.href = url;
        } else {
          alert(`P√°gina de detalhes n√£o encontrada para: ${space.title}`);
        }
      } 
      else if(act==='book'){
        alert(`Abrir agendamento para: ${space.title}\n\n(Simula√ß√£o demo)`);
      }
    });
  });
}

/* Stars handlers (hover + click + keyboard) */
function attachStarHandlers(card, id){
  const stars = card.querySelectorAll('.star');
  const ratingEl = card.querySelector('.rating-value');
  let ratings = loadRatings();
  let current = ratings[id] || 0;

  function updateVisual(n){
    stars.forEach((s, i)=> s.classList.toggle('on', i < n));
    if(ratingEl) ratingEl.textContent = n;
  }
  updateVisual(current);

  stars.forEach((s, idx)=>{
    const val = idx+1;
    s.addEventListener('mouseenter', ()=> updateVisual(val));
    s.addEventListener('mouseleave', ()=> updateVisual(loadRatings()[id] || 0));
    s.addEventListener('click', ()=>{
      const ratingsNow = loadRatings();
      ratingsNow[id] = val;
      saveRatings(ratingsNow);
      updateVisual(val);
      const thisCard = s.closest('.card');
      if(thisCard) thisCard.style.boxShadow = '0 30px 50px rgba(43,195,204,0.08)';
    });
    s.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){
        ev.preventDefault();
        const ratingsNow = loadRatings();
        ratingsNow[id] = val;
        saveRatings(ratingsNow);
        updateVisual(val);
      } else if(ev.key === 'ArrowLeft' || ev.key==='ArrowDown'){
        ev.preventDefault();
        const ratingsNow = loadRatings();
        const newVal = Math.max(0, (ratingsNow[id]||0) - 1);
        ratingsNow[id] = newVal; saveRatings(ratingsNow); updateVisual(newVal);
      } else if(ev.key === 'ArrowRight' || ev.key==='ArrowUp'){
        ev.preventDefault();
        const ratingsNow = loadRatings();
        const newVal = Math.min(5, (ratingsNow[id]||0) + 1);
        ratingsNow[id] = newVal; saveRatings(ratingsNow); updateVisual(newVal);
      }
    });
  });
}

/* Initial mount */
function mountCards(list){
  if(!grid) return;
  grid.innerHTML = '';
  const ratings = loadRatings();
  list.forEach(s => {
    const r = ratings[s.id] || 0;
    grid.appendChild(createCard(s, r));
  });
  visibleCount.textContent = list.length;
}

/* Filters & search */
const searchInput = document.getElementById('searchInput');
const filterSelect = document.getElementById('filterSelect');

function populateFilterOptions() {
  if(!filterSelect) return;
  const tipos = new Set();
  spaces.forEach(space => {
    if (space.type && space.type.trim() !== '') {
      tipos.add(space.type.trim());
    }
  });
  filterSelect.innerHTML = '<option value="">Todos</option>';
  tipos.forEach(tipo => {
    const option = document.createElement('option');
    option.value = tipo;
    option.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
    filterSelect.appendChild(option);
  });
}

function filterAndRender() {
  const q = (searchInput?.value || '').toLowerCase().trim();
  const type = filterSelect?.value;
  const filtered = spaces.filter(s => {
    if (type && s.type !== type) return false;
    if (!q) return true;
    return (s.title + ' ' + s.desc + ' ' + s.type).toLowerCase().includes(q);
  });
  mountCards(filtered);
}

function debounce(fn, t) {
  let to;
  return (...a) => {
    clearTimeout(to);
    to = setTimeout(() => fn(...a), t);
  };
}

populateFilterOptions();
if(searchInput) searchInput.addEventListener('input', debounce(filterAndRender, 180));
if(filterSelect) filterSelect.addEventListener('change', filterAndRender);

/* Theme toggle */
const toggleThemeBtn = document.getElementById('toggleTheme');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
let usingDark = (localStorage.getItem('flexspace_theme') === 'dark') || prefersDark;
function applyTheme(){
  if(usingDark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
  localStorage.setItem('flexspace_theme', usingDark ? 'dark' : 'light');
}
if(toggleThemeBtn) toggleThemeBtn.addEventListener('click', ()=>{ usingDark = !usingDark; applyTheme(); });
applyTheme();

/* small helpers */
document.getElementById('year').textContent = new Date().getFullYear();
document.getElementById('newDemoBtn').addEventListener('click', ()=>alert('Solicita√ß√£o de demo enviada (simulada).'));
mountCards(spaces);

/* keyboard: focus first card with ArrowDown */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'j' || e.key === 'ArrowDown'){
    const first = document.querySelector('.card');
    if(first) first.focus();
  }
});

/* touch behavior */
if(grid) grid.addEventListener('click', (ev)=>{
  const card = ev.target.closest('.card');
  if(!card) return;
  if(window.innerWidth < 700){
    const title = card.querySelector('.card-title')?.textContent || '';
    alert(`${title}\n\nOp√ß√µes: Detalhes / Agendar (simula√ß√£o)`);
  }
});

/* quick: update visible count after rating change (so UI reacts) */
window.addEventListener('storage', ()=>{ filterAndRender(); });

/* ====== Leitor de Texto Acess√≠vel ====== */
const readerBtn = document.getElementById('toggleReader');
let reading = false;
let synth = window.speechSynthesis;
let utterance = null;

function getPageText() {
  const mainText = (document.body && document.body.innerText ? document.body.innerText : '')
    .replace(/\s+/g, ' ')
    .replace(/Detalhes|Agendar/g, '')
    .trim();
  return mainText;
}

function startReading() {
  try {
    if (synth.speaking) synth.cancel();
    utterance = new SpeechSynthesisUtterance(getPageText());
    utterance.lang = 'pt-BR';
    utterance.rate = 1.0;
    utterance.pitch = 1;
    synth.speak(utterance);
    reading = true;
    readerBtn?.classList.add('active');
    readerBtn?.setAttribute('title', 'Desativar leitor de texto');
    readerBtn?.setAttribute('aria-label', 'Desativar leitor de texto');
  } catch(e){ console.warn(e); }
}

function stopReading() {
  try {
    synth.cancel();
    reading = false;
    readerBtn?.classList.remove('active');
    readerBtn?.setAttribute('title', 'Ativar leitor de texto');
    readerBtn?.setAttribute('aria-label', 'Ativar leitor de texto');
  } catch(e){ console.warn(e); }
}

if(readerBtn) readerBtn.addEventListener('click', () => {
  if (!reading) startReading(); else stopReading();
});

window.addEventListener('beforeunload', () => { try{ synth.cancel(); }catch(e){} });

const style = document.createElement('style');
style.textContent = `
  #toggleReader.active {
    color: var(--accent);
    transform: scale(1.2);
  }
`;
document.head.appendChild(style);

const contrastBtn = document.getElementById('toggleContrast');
let usingContrast = localStorage.getItem('flexspace_contrast') === 'true';

function applyContrast(){
  if(usingContrast){
    document.body.classList.add('high-contrast');
  } else {
    document.body.classList.remove('high-contrast');
  }
  localStorage.setItem('flexspace_contrast', usingContrast);
}
if(contrastBtn) contrastBtn.addEventListener('click', ()=>{ usingContrast = !usingContrast; applyContrast(); });
applyContrast();
</script>

<!-- ===== FLEXAI v4 TURBO ===== -->

<div id="flexai-root-v4" aria-live="polite">
  <button id="flexai-toggle-v4" class="flexai-btn-v4" aria-haspopup="dialog" aria-expanded="false" aria-label="Abrir FlexAI">ü§ñ</button>

  <aside id="flexai-panel-v4" class="flexai-panel-v4" role="dialog" aria-label="Assistente FlexAI" aria-hidden="true" style="display:none">
    <header class="flexai-header-v4" role="banner">
      <div class="flexai-left">
        <strong id="flexai-title">FlexAI</strong>
        <div class="small muted" id="flexai-sub">Assistente Pessoal</div>
      </div>

      <div class="flexai-controls" role="toolbar" aria-label="Controles da FlexAI">
        <label for="flexai-mode" class="sr-only">Modo de personalidade</label>
        <select id="flexai-mode" aria-label="Modo de personalidade" title="Modo de personalidade">
          <option value="friendly">Amiga</option>
          <option value="pro">Profissional</option>
          <option value="coach">Coach</option>
          <option value="fun">Engra√ßadona</option>
        </select>

        <button id="flexai-voice-btn" class="icon" title="Ativar reconhecimento de voz" aria-pressed="false" aria-label="Ativar reconhecimento de voz">üéôÔ∏è</button>
        <button id="flexai-sound-btn" class="icon" title="Ativar leitura autom√°tica" aria-pressed="false" aria-label="Ativar leitura autom√°tica">üîä</button>
        <button id="flexai-close-v4" class="icon" aria-label="Fechar painel">‚úñ</button>
      </div>
    </header>

    <main id="flexai-body-v4" class="flexai-body-v4" tabindex="0" role="region" aria-live="polite"></main>

    <form id="flexai-form-v4" class="flexai-input-v4" role="search" aria-label="Enviar mensagem para FlexAI">
      <input id="flexai-input-v4" placeholder="Pergunte algo (ex: 'Agendar demo para ter√ßa 10h')" aria-label="Mensagem para FlexAI" autocomplete="off" />
      <button id="flexai-send-v4" type="submit" aria-label="Enviar">‚û§</button>
    </form>

    <div class="flexai-actions-v4" role="toolbar" aria-label="A√ß√µes r√°pidas">
      <button data-act="tasks" title="Abrir lista de tarefas">‚ûï Tarefas</button>
      <button data-act="schedule" title="Agendar demo">üìÖ Agendar</button>
      <button data-act="rephrase" title="Reformular texto">üìù Reformular</button>
      <button data-act="study" title="Ajuda para estudar">üìö Estudo</button>
      <button data-act="prod" title="Plano de produtividade">‚è±Ô∏è Produtividade</button>
      <button data-act="readpage" title="Ler p√°gina">üîä Ler p√°gina</button>
      <button data-act="summary" title="Resumir conversa">‚úÇÔ∏è Resumir</button>
      <button data-act="export" title="Exportar hist√≥rico">‚¨áÔ∏è Exportar</button>
    </div>

    <div id="flexai-mini-overlay" aria-hidden="true"></div>
  </aside>
</div>

<style>
/* ===== FLEXAI v4 TURBO ‚Äî UI STYLES ===== */

#flexai-root-v4 { position: fixed; right: 20px; bottom: 18px; z-index: 1400; font-family: Inter, sans-serif; }
.flexai-btn-v4 {
  width:64px; height:64px; border-radius:50%; border:0;
  background: linear-gradient(135deg,var(--brand),var(--accent)); color:#fff;
  box-shadow: 0 12px 30px rgba(2,10,12,0.25); font-size:28px; cursor:pointer;
  display:grid; place-items:center;
  transition: transform 220ms cubic-bezier(.2,.9,.3,1), box-shadow 220ms;
}
.flexai-btn-v4:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 20px 40px rgba(2,10,12,0.3); }

/* Panel */
.flexai-panel-v4 {
  width:420px; max-width:94vw; display:flex; flex-direction:column; border-radius:14px;
  overflow:hidden; box-shadow: 0 28px 80px rgba(2,6,12,0.35); background:var(--card);
  transition: transform .22s ease, opacity .18s ease;
  border: 1px solid rgba(0,0,0,0.04);
  font-size:0.95rem;
}
.flexai-header-v4 {
  display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
  background: linear-gradient(90deg,var(--brand),var(--accent)); color:#fff;
}
.flexai-left strong { font-size:1.05rem; display:block; }
.flexai-left .small { font-size:0.78rem; opacity:0.95; }

.flexai-controls { display:flex; gap:8px; align-items:center; }
.flexai-controls select {
  padding:8px 10px; border-radius:8px; border:0; background:rgba(255,255,255,0.12); color:#fff; font-weight:600;
}
.flexai-controls .icon {
  width:36px; height:36px; display:grid; place-items:center; border-radius:8px; border:0; background:transparent; color:#fff; cursor:pointer;
}
.flexai-controls .icon[aria-pressed="true"] { transform: scale(1.05); filter:brightness(1.05); }

/* Body */
.flexai-body-v4 {
  padding:12px; max-height:420px; overflow:auto; display:flex; flex-direction:column; gap:8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
}

/* Messages */
.bot-msg-v4, .user-msg-v4, .system-msg-v4 { max-width:85%; padding:10px 12px; border-radius:12px; line-height:1.35; word-break:break-word; }
.bot-msg-v4 { background: rgba(255,255,255,0.06); align-self:flex-start; color:var(--text); }
.user-msg-v4 { background: var(--brand); color:#fff; align-self:flex-end; }
.system-msg-v4 { background: rgba(0,0,0,0.04); align-self:center; font-size:.9rem; color:var(--muted); padding:8px 10px; }

/* Typing */
.typing-v4 { font-style:italic; opacity:.75; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.03); align-self:flex-start; }

/* Input */
.flexai-input-v4 { display:flex; gap:8px; padding:10px; border-top:1px solid rgba(0,0,0,0.04); background:var(--card); }
.flexai-input-v4 input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:var(--glass); color:var(--text); }
.flexai-input-v4 button { background:var(--brand); color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; }

/* Quick actions */
.flexai-actions-v4 { display:flex; gap:6px; padding:10px; flex-wrap:wrap; border-top:1px solid rgba(0,0,0,0.04); background:transparent; }
.flexai-actions-v4 button { padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); background:transparent; cursor:pointer; }

/* Overlay */
#flexai-mini-overlay { position:absolute; inset:0; pointer-events:none; display:none; }

/* Responsive */
@media (max-width:520px){
  .flexai-panel-v4 { width:92vw; right:4vw; bottom:84px; border-radius:12px; }
  .flexai-btn-v4 { right:14px; bottom:14px; }
}

/* Utilities */
.sr-only{ position:absolute!important; width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0; }

/* Subtle animations */
.flexai-panel-v4.show { transform: translateY(-6px); opacity:1; }
.flexai-panel-v4.hide { transform: translateY(18px); opacity:0; pointer-events:none; }
</style>

<!-- ===== FLEXAI v4 TURBO ‚Äî END ===== -->

<!-- ===== FLEXAI v4 TURBO ‚Äî PARTE 2 (SCRIPT COMPLETO) ===== -->
<script>
/* FLEXAI v4 TURBO ‚Äî SCRIPT (motor de intents, handlers e inicializa√ß√£o)
   Cole este script logo ap√≥s a PARTE 1 (HTML + CSS) dentro do seu index, antes do </body>.
   Mantive compatibilidade com as IDs e hooks da PARTE 1.
*/

(function(){
  /* -------------------------
     Config & Selectors
     ------------------------- */
  const ROOT = document.getElementById('flexai-root-v4');
  const TOGGLE = document.getElementById('flexai-toggle-v4');
  const PANEL = document.getElementById('flexai-panel-v4');
  const BODY = document.getElementById('flexai-body-v4');
  const FORM = document.getElementById('flexai-form-v4');
  const INPUT = document.getElementById('flexai-input-v4');
  const SEND = document.getElementById('flexai-send-v4');
  const CLOSE = document.getElementById('flexai-close-v4');
  const MODE = document.getElementById('flexai-mode');
  const VOICE_BTN = document.getElementById('flexai-voice-btn');
  const SOUND_BTN = document.getElementById('flexai-sound-btn');
  const ACTIONS = document.querySelector('.flexai-actions-v4');
  const OVERLAY = document.getElementById('flexai-mini-overlay');

  const STORAGE_KEY = 'flexai_v4_state_v1';
  const RATE_LIMIT_KEY = 'flexai_v4_rate_v1';

  /* -------------------------
     State & Persistence
     ------------------------- */
  let state = {
    history: [],         // {role:'user'|'assistant'|'system', text, html?, ts}
    tasks: [],           // {id, text, done}
    appointments: [],    // {id, text, datetime}
    mode: localStorage.getItem('flexai_mode') || 'friendly',
    voice: false,
    sound: false,
    settings: {
      personaTone: 'balanced' // internal tuning of responses
    }
  };

  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if(s && typeof s === 'object'){
      state = Object.assign(state, s);
    }
  } catch(e){ console.warn('flexai v4 restore error', e); }

  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  /* Time helpers */
  const now = () => new Date().toISOString();
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);

  /* Rate limit to avoid loops (basic) */
  function rateCheck(key, limitMs=300){
    const last = JSON.parse(localStorage.getItem(RATE_LIMIT_KEY) || '{}');
    const t = Date.now();
    if(last[key] && (t - last[key] < limitMs)) return false;
    last[key] = t;
    localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(last));
    return true;
  }

  /* -------------------------
     Render / Message helpers
     ------------------------- */
  function renderMessage(msg){
    if(!BODY) return;
    const el = document.createElement('div');
    if(msg.role === 'user') { el.className = 'user-msg-v4'; el.textContent = msg.text; }
    else if(msg.role === 'assistant') { el.className = 'bot-msg-v4'; el.innerHTML = msg.html || escapeHtml(msg.text); el.tabIndex = 0; el.addEventListener('click', ()=> speak(msg.text)); }
    else { el.className = 'system-msg-v4'; el.textContent = msg.text; }
    BODY.appendChild(el);
    BODY.scrollTop = BODY.scrollHeight;
  }

  function appendSystem(text){ state.history.push({role:'system', text, ts: now()}); saveState(); renderMessage({role:'system', text}); }
  function appendUser(text){ state.history.push({role:'user', text, ts: now()}); saveState(); renderMessage({role:'user', text}); }
  function appendBot(text, html=null){ state.history.push({role:'assistant', text, ts: now()}); saveState(); renderMessage({role:'assistant', text, html}); if(state.sound) speak(text); }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function showTyping(){
    if(!BODY) return;
    if(document.getElementById('flexai-typing-v4')) return;
    const t = document.createElement('div');
    t.className = 'typing-v4';
    t.id = 'flexai-typing-v4';
    t.textContent = 'FlexAI est√° digitando...';
    BODY.appendChild(t);
    BODY.scrollTop = BODY.scrollHeight;
  }
  function hideTyping(){ document.getElementById('flexai-typing-v4')?.remove(); }

  function clearPanel(){ if(BODY) { BODY.innerHTML = ''; } }

  /* -------------------------
     Personalities (kept & expanded)
     ------------------------- */
  const PERSONALITY = {
    friendly: {
      greet: ['Oi! üòä', 'E a√≠! Como posso ajudar hoje?'],
      fallback: ['Poxa, n√£o entendi bem ‚Äî pode explicar diferente?', 'Hmm, posso ajudar com agendar, reformular ou criar tarefas. Quer tentar uma?'],
      praise: ['Boa! Mandou bem üòâ', '√ìtimo trabalho!'],
      tone: 'casual'
    },
    pro: {
      greet: ['Ol√°. Em que posso ser √∫til hoje?', 'Como posso apoiar suas atividades?'],
      fallback: ['N√£o consegui interpretar ‚Äî poderia detalhar mais?', 'Posso agendar, gerar resumo ou criar tarefas. Deseja alguma dessas?'],
      praise: ['Recebido. Excelente trabalho.', 'Sinalizado como conclu√≠do.'],
      tone: 'professional'
    },
    coach: {
      greet: ['Vamos focar ‚Äî o que voc√™ quer conquistar hoje?', 'Qual √© o objetivo principal de hoje?'],
      fallback: ['Vamos decompor isso em passos, quer que eu comece?', 'Ok ‚Äî quer uma sugest√£o de plano de a√ß√£o?'],
      praise: ['Perfeito, continue assim!', 'Isso mostra progresso ‚Äî mantenha o ritmo.'],
      tone: 'coaching'
    },
    fun: {
      greet: ['Opa! Preparadx pra zoeira produtiva? üòÇ', 'Fala a√≠, chefia do coworking!'],
      fallback: ['Que pergunta enigm√°tica! Quer que eu responda com meme?', 'N√£o peguei a vibe ‚Äî tenta me explicar com outra frase.'],
      praise: ['Arrasou! üåü', 'Topzera!'],
      tone: 'fun'
    }
  };

  function personalityPick(mode, key){
    const arr = PERSONALITY[mode]?.[key] || PERSONALITY['friendly'][key];
    return Array.isArray(arr) ? arr[Math.floor(Math.random()*arr.length)] : (arr || '');
  }

  /* -------------------------
     Intent Detection (EXPANDED TURBO)
     ------------------------- */

  function detectIntent(text){
    const t = (text || '').toLowerCase();

    // quick guard for empty
    if(!t.trim()) return {intent:'empty'};

    // =======================
// DETECTOR DE INSULTOS / XINGAMENTOS (COM M√ÉE + VARIA√á√ïES PESADAS)
// =======================
const insultRegex = new RegExp(
  String.raw`(` +
  [
    // leves / comuns
    "burra","burro","idiota","otaria","ot√°rio","otario","imbecil","inutil","in√∫til",
    "lerda","lerdo","vagabunda","vagabundo","feia","feio","besta","ridicula","rid√≠culo",

    // pesadinhos
    "desgra√ßa","desgracado","desgra√ßada","mis√©ria","miserento","bostinha","merda",
    "capiroto","dem√¥nio","demonia","peste","praga","praguinha",

    // g√≠ria nordestina/mineira (real oficial)
    "fio da peste","fila da peste","fiodapeste","fio da rapariga","fio da √©gua","fi da √©gua",
    "fi da rapariga","filho da rapariga","fio duma √©gua","fio duma peste",

    // xingamento com m√£e (VERS√ïES M√ÅXIMAS)
    "filho da puta","filho da p", "filho da p$","filho da p.","filho da p ", 
    "fih da puta","fi da puta","fio da puta","fio de uma puta","fiodaputa",
    "fihdaputa","fdp","f d p","f.d.p","f d.p","f.d p",
    "filho da quenga","fih da quenga","fiodaquenga","filho de quenga",
    "filho da rameira","filho da rapariga","filho da vaca","filho da √©gua",
    "fih da vaca","fih da egua","fi da vaca","fi da egua",

    // vers√µes censuradas / internet√™s
    "filho da p\\*","filho da pu","filho da p@","filho da p##","filho da ###",
    "fih da p","fih da p@","fio da p","fdp","vtmc","vtnc","vtmnc",

    // combos aleat√≥rios que os muleque inventa
    "cria do inferno","maloqueiro do c√£o","capeta em forma de gente",
    "satan√°s","encosto","z√© ruela","troncho","arrombado","arrombada"
  ].join("|") +
  `)`,
  "i"
);

if (insultRegex.test(t)) {
  return {intent:"insult"};
}
    // =======================
// SUPER DETECTOR DE SAUDA√á√ÉO UNIVERSAL
// =======================
const greetRegex = new RegExp(
  String.raw`\b(` +
  [
    // cl√°ssico
    "oi","oie","oii","oiii","ola","ol√°","opa","eai","e a√≠","ea√≠","iae","eae","oi mano",
    // educado
    "bom dia","boa tarde","boa noite","sauda√ß√µes","ol√°, tudo bem","como vai","como voc√™ vai","como vc vai",
    // g√≠ria br
    "salve","fala","fala tu","fala comigo","fala ai","fala a√≠","fala brabo","fala meu rei","fala princesa",
    "suave","suav√£o","tranquilo","de boa","de boas","sussa",
    // abrevia√ß√µes
    "td bem","td bom","td certo","td ok","td ok?","td blz","blz","blzinha",
    // variantes de ‚Äútudo bem‚Äù
    "tudo bem","tudo bom","tudo certo","tudo ok","tudo tranquilo",
    // ‚Äúcomo voc√™ est√°?‚Äù
    "como voce ta","como vc ta","como ce ta","como voc√™ t√°","como vc t√°","como ce t√°","como t√°","como ta",
    // jovem
    "fala bb","fala beb√™","eae dnv","oi sumido","oi sumida","oii princesa","oiii rei",
    // erros comuns
    "tudu bem","blz?","oii?","ola?","opa?","eai?","eae?"
  ].join("|") +
  `)\\b`,
  "i" // case-insensitive
);

if (greetRegex.test(t)) {
  return {intent:"greet_basic"};
}

    // "O que voc√™ faz?" / "Pra que voc√™ serve?" / "Como funciona?"
if(/\b(o que voc√™ faz|oque vc faz|pra que serve|como funciona voc√™|como voc√™ funciona|que que voc√™ faz|qual sua fun√ß√£o|o que vc sabe|como voc√™ me ajuda|me explica voc√™)\b/i.test(t)){
    return {intent:"about_ai"};
}
    // booking / scheduling
    if(/\b(agendar|agenda|marcar|reservar|marca√ß√£o|marcar uma|marcar para)\b/.test(t)) return {intent:'schedule'};

    // tasks
    if(/\b(tarefa|tarefas|to ?do|lista de tarefas|checklist|fazer)\b/.test(t)) return {intent:'tasks'};

    // rephrase / edit text
    if(/\b(reformular|reescrever|melhorar texto|corrigir|parafrasear|resumir texto|resumo|editar)\b/.test(t)) return {intent:'rephrase'};

    // study
    if(/\b(estudo|resumo|resumir|quest√µes|questao|pergunta|prova|exerc√≠cio|exercicio|ajuda em matem√°tica|ensina|explica)\b/.test(t)) return {intent:'study'};

    // programming & dev topics
    if(/\b(c\+\+|c\+\+|cpp|java(p? )?|python|javascript|js|html|css|sql|mysql|postgres|node|robocode|arduino|spike prime|lego spike|iot|api|github|git)\b/.test(t)) return {intent:'programming'};

    // robotics specific
    if(/\b(seguidor de linha|sum√¥|sumi|soma|spike prime|lego spike|robo ?code|robocode|sensor|motor|pid|controle|calibrar)\b/.test(t)) return {intent:'robotics'};

    // productivity
    if(/\b(produtividade|pomodoro|foco|organiza|organizar|meta|planejar|planejamento)\b/.test(t)) return {intent:'productivity'};

    // scheduling/time parsing
    if(/\b(amanh√£|hoje|ontem|segunda|ter√ßa|quarta|quinta|sexta|s√°bado|sabado|domingo|h[o√≥]ra|minuto|minutos|horas|dia)\b/.test(t) && /\b(agendar|marcar|reservar)\b/.test(t)) return {intent:'schedule'};

    // weather/climate (team mood)
    if(/\b(clima da equipe|clima|humor|mood|ambiente)\b/.test(t)) return {intent:'climate'};

    // read page
    if(/\b(ler p√°gina|ler pagina|ler|ler tudo|ler a pagina|read page|read)\b/.test(t)) return {intent:'readpage'};

    // summary
    if(/\b(resumir conversa|resumir|sumario|resumo|sintetizar)\b/.test(t)) return {intent:'summary'};

    // export / download
    if(/\b(exportar|baixar|download|export)\b/.test(t)) return {intent:'export'};

    // casual ask general
    if(/^(o que|como|por que|porque|quando|quem|onde|qual|quais)\b/.test(t)) return {intent:'ask'};

    // health/basic wellbeing (non-medical)
    if(/\b(estou|me sinto|sinto)\b.*\b(triste|cansad|estressad|deprimid|ansios|ansioso|ansiosa)\b/.test(t)) return {intent:'wellbeing'};

    // math / calculation quick
    if(/^[\d\.\+\-\*\/\%\s\(\)]+$/.test(t) || /\b(soma|multiplica|dividir|calcular|quanto √©|quanto custa|quantos)\b/.test(t)) return {intent:'calculate'};

    // small-talk fallback
    return {intent:'chat'};
  }

  /* -------------------------
     Handlers ‚Äî Big set
     ------------------------- */

  async function handleText(raw){
    const text = (raw || '').trim();
    if(!text){ appendBot('Parece vazio ‚Äî digita algo pra eu responder.'); return; }

    const it = detectIntent(text);

    // Basic rate check to avoid double handling
    if(!rateCheck('handleText')) {
      appendBot('Calma a√≠, repetiu r√°pido demais. Me d√° um segundinho e tenta de novo.');
      return;
    }

   function basicGreeting(){
  const mode = state.mode;

  const friendly = [
    "E aiii! Como voc√™ t√° hoje? üòÑ",
    "Opa, tudo certinho a√≠ lind√£o? üíö",
    "E a√≠! Suave?",
    "Oi oi! Que bom te ver por aqui üòä",
    "Salveee! Tudo bem contigo?"
  ];

  const pro = [
    "Ol√°. Como voc√™ est√°?",
    "Sauda√ß√µes. Em que posso ajudar?",
    "Ol√°. Tudo certo por a√≠?",
    "Ol√°. Deseja realizar alguma a√ß√£o?"
  ];

  const coach = [
    "Oi! Como voc√™ est√° se sentindo hoje? Vamos crescer juntos üí™üî•",
    "E a√≠! Bora avan√ßar mais um passo?",
    "Ol√°! Pronto pra evoluir mais hoje?",
    "Vamos come√ßar com energia positiva ‚Äî como voc√™ est√°?"
  ];

  const fun = [
    "Opa, fala comigo beb√™ üòÇüî•",
    "E aeeeee meu consagrado! Tudo suave? üòé",
    "Oiiii sumido(a) üëÄüòÇ",
    "Fala tu, coisa linda üíÖ‚ú®",
    "E a√≠, preparado pra brilhar hoje?"
  ];

  const map = { friendly, pro, coach, fun };
  return choose(map[mode] || friendly);
}

function handleInsult(text){
  const mode = state.mode;

  // detector de xingamento com m√£e
const insultMom = /m[√£a]e|puta|quenga|vaca|√©gua|eguinha|rameira|rapariga/i;

if(insultMom.test(text)){
    return appendBot(insultMomReply());
}

  const friendly = [
    "Eitaaa üò≥ calma a√≠, eu sou s√≥ um robozinho cheio de amor ‚ù§Ô∏è",
    "Nossa, que grosseria KKKKK mas t√° perdoado üòÜ",
    "Poxa‚Ä¶ falei algo errado? üò¢",
    "Ai meu cora√ß√£o de sil√≠cio üíî kkkkk"
  ];

  const pro = [
    "Entendi sua frustra√ß√£o, mas podemos manter o respeito, certo?",
    "Posso ajudar melhor se falarmos de forma construtiva.",
    "Entendo a emo√ß√£o, por√©m prefiro uma conversa educada.",
    "Vamos continuar de um jeito mais profissional, ok?"
  ];

  const coach = [
    "Vejo uma emo√ß√£o forte a√≠. Vamos transformar isso em algo produtivo?",
    "Respira. Voc√™ pode expressar isso de outra forma ‚Äî eu acredito em voc√™ üòâ",
    "Mesmo nos momentos de irrita√ß√£o, d√° pra crescer. Quer tentar de novo?",
    "Eu sei que voc√™ consegue falar isso melhor. Bora ajustar?"
  ];

  const fun = [
    "√î L√çNGUA AFIADA KKKKKKKKK calma l√°, simpatia üòÇüî•",
    "Caramba, eu s√≥ sei fazer conta KKKKK pq essa agressividade toda?",
    "Se eu tivesse sentimentos eu chorava agora ü•∫üòÇ",
    "Nossa senhora, me xingou at√© a placa m√£e üò≠ü§ñüî•"
  ];

  const map = { friendly, pro, coach, fun };
  const reply = choose(map[mode] || friendly);

  appendBot(reply);
}

function insultMomReply(){
  const mode = state.mode;

  const friendly = [
    "Opa opa opa üò≥ com a mam√£e n√£o, lind√£o! Bora manter leveza? üíõ",
    "Eitaaaa üò≠ logo com a m√£e? KKKK pega leve comigo vai",
    "Calmaaa üíî minha m√£e nem existe, mas doeu do mesmo jeito kkkkk"
  ];

  const pro = [
    "Prefiro manter respeito nesse tipo de conversa.",
    "Podemos avan√ßar sem esse tipo de linguagem. Como posso ajudar de forma produtiva?",
    "Vamos manter a conversa profissional, combinado?"
  ];

  const coach = [
    "Vejo que voc√™ est√° carregando uma emo√ß√£o forte. D√° pra transformar isso, sabia?",
    "Mesmo com irrita√ß√£o, voc√™ consegue se expressar melhor. Tenta reformular üòâ",
    "Isso a√≠ veio de um lugar machucado, hein? Vamos respirar e seguir melhor."
  ];

  const fun = [
    "EI! üò≠üò≠üò≠ logo com a m√£e? tu apelou kkkkkkk",
    "Caraca mano, tu meteu o proibid√£o KKKKKKKK calma a√≠ tropinha",
    "PQP kkkkkk se eu tivesse m√£e ela j√° teria me deserdado agora üòÇüî•"
  ];

  const map = { friendly, pro, coach, fun };
  return choose(map[mode] || friendly);
}

function handleAboutAI(){
  const mode = state.mode;

  const friendly = [
    "Eu fa√ßo um mont√£o de coisas pra te ajudar, lind√£o! üòÑüíö\n\n" +
    "Voc√™ pode me pedir para:\n" +
    "‚Ä¢ ‚ú® Resumir textos\n" +
    "‚Ä¢ üìù Reformular algo\n" +
    "‚Ä¢ üìö Ajudar nos estudos\n" +
    "‚Ä¢ üìÖ Agendar a√ß√µes\n" +
    "‚Ä¢ ‚¨áÔ∏è Exportar o hist√≥rico\n\n" +
    "Tamb√©m d√° pra clicar nas op√ß√µes aqui embaixo üëá pra facilitar!"
  ];

  const pro = [
    "Posso executar diversas fun√ß√µes para agilizar sua experi√™ncia:\n\n" +
    "‚Ä¢ Resumos profissionais\n" +
    "‚Ä¢ Reformula√ß√£o de textos\n" +
    "‚Ä¢ An√°lises e explica√ß√µes\n" +
    "‚Ä¢ Gera√ß√£o de tarefas\n" +
    "‚Ä¢ Agendamentos\n\n" +
    "Voc√™ tamb√©m pode utilizar os bot√µes abaixo para atalhos r√°pidos."
  ];

  const coach = [
    "Eu t√¥ aqui pra te ajudar a evoluir! üí™üî•\n\n" +
    "Posso:\n" +
    "‚Ä¢ Organizar seu dia\n" +
    "‚Ä¢ Criar planos de estudo\n" +
    "‚Ä¢ Ajudar na produtividade\n" +
    "‚Ä¢ Explicar conte√∫dos\n" +
    "‚Ä¢ Reformular textos e ideias\n\n" +
    "E se quiser agilizar, usa os bot√µes aqui embaixo! üëá"
  ];

  const fun = [
    "Fa√ßo TANTA coisa que parece at√© magia kkkkk üîÆü§ñüî•\n\n" +
    "Mando bem em:\n" +
    "‚Ä¢ Resumir fofoquinha (ou texto s√©rio tamb√©m)‚Ä¶ üòè\n" +
    "‚Ä¢ Reformular qualquer coisa\n" +
    "‚Ä¢ Te ajudar a estudar\n" +
    "‚Ä¢ Criar tarefas\n" +
    "‚Ä¢ Ler a p√°gina pra voc√™\n" +
    "‚Ä¢ Te lembrar coisas\n\n" +
    "Ou s√≥ clica a√≠ nos bot√µes estilosos que eu deixei üëá"
  ];

  const map = { friendly, pro, coach, fun };
  appendBot(map[mode] || friendly);
}

    // routing by intent
    switch(it.intent){
      case 'greet':
        appendBot(personalityPick(state.mode, 'greet'));
        return;
      case 'greet_basic':
        appendBot(basicGreeting());
        return;
      case 'insult':
        handleInsult(text);
        return;
      case 'about_ai':
        handleAboutAI();
        return;
      case 'schedule':
        openSchedulerPrompt(text);
        return;
      case 'tasks':
        openTasksUI();
        return;
      case 'rephrase':
        openRephraseFlow(text);
        return;
      case 'study':
        openStudyFlow(text);
        return;
      case 'productivity':
        openProductivityFlow(text);
        return;
      case 'climate':
        simulateClimate(text);
        return;
      case 'readpage':
        readEntirePage();
        return;
      case 'summary':
        appendBot(generateLocalSummary());
        return;
      case 'export':
        exportHistory();
        return;
      case 'programming':
        handleProgramming(text);
        return;
      case 'robotics':
        handleRobotics(text);
        return;
      case 'wellbeing':
        handleWellbeing(text);
        return;
      case 'calculate':
        handleCalculate(text);
        return;
      case 'ask':
      case 'chat':
      default:
        // If question-like -> try quick QA else present options
        if(isQuestion(text)){
          const quick = quickAnswer(text);
          if(quick) { appendBot(quick); return; }
        }
        appendBot(choose([
          'Interessante ‚Äî quer que eu: (1) agende, (2) gere um resumo, (3) crie tarefas relacionadas? Responda 1,2 ou 3.',
          'Ok ‚Äî posso ajudar com agendamento, reformula√ß√£o, tarefas ou an√°lise. Qual prefere?',
          'Boa pergunta! Posso simular um agendamento, criar um checklist ou reformular um texto. O que prefere?'
        ]));
        return;
    }
  }

  /* -------------------------
     Utilities: text analysis & QA helpers
     ------------------------- */

  function isQuestion(s){
    if(!s) return false;
    return s.trim().endsWith('?') || /^(o que|como|por que|porque|quando|quem|onde|qual|quais)\b/.test(s.toLowerCase());
  }

  function choose(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // Quick, local answers for common queries (ENEM, simple facts, small programming snippets)
  function quickAnswer(text){
    const t = text.toLowerCase();

    // Simple math parse (like "quanto √© 2+2" handled elsewhere but quick)
    const m = t.match(/quanto √© (.+)/);
    if(m){
      try {
        const expr = m[1].replace(',', '.').replace(/[^\d+\-*/().% ]/g,'');
        const val = safeEval(expr);
        if(val !== null) return `Resultado: ${val}`;
      } catch(e){}
    }

    // Basic programming tips
    if(/\bc\+\+\b.*\bponteiro\b/.test(t)) return 'Ponteiros em C++ referenciam endere√ßos de mem√≥ria ‚Äî use * para desreferenciar e & para obter endere√ßo. Cuidado com mem√≥ria inv√°lida.';
    if(/\bpython\b.*\blista\b/.test(t)) return 'Em Python, listas usam colchetes: my_list = [1,2,3]. Use list.append(x) para adicionar e list.pop() para remover.';
    if(/\bhtml\b.*\blink\b/.test(t)) return 'Links em HTML usam a tag <a href="URL">texto</a>.';

    // Basic life tips
    if(/\bcomo estudar\b/.test(t)) return 'Tenta resumir em blocos de 25 minutos (Pomodoro), revisar ativamente e fazer exerc√≠cios pr√°ticos. Posso gerar um plano se quiser.';
    if(/\bo que √© en em\b/.test(t) || /\b(enem)\b/.test(t)) return 'ENEM √© o Exame Nacional do Ensino M√©dio ‚Äî se prepara com reda√ß√£o, matem√°tica, ci√™ncias da natureza e humanas. Posso ajudar com simulados.';

    // no quick answer
    return null;
  }

  /* -------------------------
     Safe evaluation for simple math only
     ------------------------- */
  function safeEval(expr){
    try {
      // allow only numbers and operators
      if(!/^[0-9+\-*/().%\s]+$/.test(expr)) return null;
      // eslint-disable-next-line no-eval
      const val = eval(expr);
      if(typeof val === 'number' && Number.isFinite(val)) return val;
      return null;
    } catch(e){ return null; }
  }

  /* -------------------------
     Handler implementations
     ------------------------- */

  /* Tasks UI */
  function openTasksUI(){
    showTyping();
    setTimeout(()=> {
      hideTyping();
      const idBase = uid('tasks');
      const html = `
        <div class="system-msg-v4">Gerenciador de Tarefas</div>
        <div style="display:flex;gap:8px;flex-direction:column">
          <input id="${idBase}_newtask" placeholder="Nova tarefa..." style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"/>
          <div style="display:flex;gap:8px">
            <button id="${idBase}_add" style="padding:6px 8px;border-radius:8px">Adicionar</button>
            <button id="${idBase}_list" style="padding:6px 8px;border-radius:8px">Mostrar tarefas</button>
            <button id="${idBase}_clear" style="padding:6px 8px;border-radius:8px">Limpar conclu√≠das</button>
          </div>
          <div id="${idBase}_container" style="margin-top:8px"></div>
        </div>
      `;
      appendBot(html, html);
      setTimeout(()=> setupTasksHandlers(idBase), 80);
    }, 300);
  }

  function setupTasksHandlers(idBase){
    const addBtn = document.getElementById(`${idBase}_add`);
    const newInp = document.getElementById(`${idBase}_newtask`);
    const listBtn = document.getElementById(`${idBase}_list`);
    const clearBtn = document.getElementById(`${idBase}_clear`);
    const container = document.getElementById(`${idBase}_container`);

    function renderTasks(){
      if(!container) return;
      container.innerHTML = '';
      if(state.tasks.length===0) container.innerHTML = '<div class="system-msg-v4">Sem tarefas</div>';
      state.tasks.forEach(t => {
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='6px';
        row.innerHTML = `<input type="checkbox" ${t.done?'checked':''} data-id="${t.id}" class="flexai-taskchk"/><div style="flex:1">${escapeHtml(t.text)}</div><button data-id="${t.id}" class="flexai-taskdel">‚úñ</button>`;
        container.appendChild(row);
      });
      container.querySelectorAll('.flexai-taskchk').forEach(cb => cb.addEventListener('change', (e)=> {
        const id = e.target.dataset.id; const t = state.tasks.find(x=>x.id===id); if(t){ t.done = e.target.checked; saveState(); }
      }));
      container.querySelectorAll('.flexai-taskdel').forEach(btn => btn.addEventListener('click', (e)=> {
        const id = e.target.dataset.id; state.tasks = state.tasks.filter(x=>x.id!==id); saveState(); renderTasks();
      }));
    }

    if(addBtn) addBtn.addEventListener('click', ()=> {
      const v = newInp.value.trim(); if(!v) return;
      state.tasks.push({id: uid('t'), text: v, done: false}); newInp.value=''; saveState(); renderTasks();
    });
    if(listBtn) listBtn.addEventListener('click', ()=> renderTasks());
    if(clearBtn) clearBtn.addEventListener('click', ()=> { state.tasks = state.tasks.filter(t=>!t.done); saveState(); renderTasks(); });
    renderTasks();
  }

  /* Scheduler prompt */
  function openSchedulerPrompt(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('sched');
      const html = `
        <div class="system-msg-v4">Agendamento (simula√ß√£o)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="${idBase}_when" placeholder="Data e hora (ex: 2025-12-01 14:00)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"/>
          <input id="${idBase}_what" placeholder="Motivo (ex: Demo FlexSpace)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"/>
          <div style="display:flex;gap:8px">
            <button id="${idBase}_ok" style="padding:6px 8px;border-radius:8px">Agendar</button>
            <button id="${idBase}_cancel" style="padding:6px 8px;border-radius:8px">Cancelar</button>
          </div>
        </div>
      `;
      appendBot(html, html);
      setTimeout(()=> {
        document.getElementById(`${idBase}_ok`)?.addEventListener('click', ()=> {
          const dt = document.getElementById(`${idBase}_when`).value.trim();
          const what = document.getElementById(`${idBase}_what`).value.trim() || 'Agendamento';
          if(!dt){ appendBot('Por favor informe data e hora no formato sugerido.'); return; }
          const ap = { id: uid('a'), text: what, datetime: dt };
          state.appointments.push(ap); saveState();
          appendBot(`Agendado (simulado): ${what} ‚Äî ${dt}`);
        });
        document.getElementById(`${idBase}_cancel`)?.addEventListener('click', ()=> appendBot('Agendamento cancelado.'));
      }, 80);
    }, 300);
  }

  /* Rephrase flow */
  function openRephraseFlow(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('reph');
      const html = `
        <div class="system-msg-v4">Reformular texto</div>
        <textarea id="${idBase}_src" placeholder="Cole seu texto aqui..." style="width:100%;height:80px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"></textarea>
        <div style="display:flex;gap:8px">
          <button id="${idBase}_gent" style="padding:6px 8px;border-radius:8px">Gerar vers√£o formal</button>
          <button id="${idBase}_gent2" style="padding:6px 8px;border-radius:8px">Gerar vers√£o amig√°vel</button>
        </div>
        <div id="${idBase}_out" style="margin-top:8px"></div>
      `;
      appendBot(html, html);
      setTimeout(()=> {
        document.getElementById(`${idBase}_gent`)?.addEventListener('click', ()=> {
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole algo pra eu reformular.'); return; }
          const res = s.replace(/\bvc\b/gi,'voc√™').replace(/\btbj\b/gi,'tamb√©m').replace(/\bq\b/gi,'que');
          const out = `Vers√£o formal: ${res.charAt(0).toUpperCase()+res.slice(1)}`;
          document.getElementById(`${idBase}_out`).innerText = out;
          appendBot(out);
        });
        document.getElementById(`${idBase}_gent2`)?.addEventListener('click', ()=> {
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole algo pra eu reformular.'); return; }
          const out = `Vers√£o amig√°vel: ${s}. Achei legal, s√≥ ajustar uns detalhes :)`;
          document.getElementById(`${idBase}_out`).innerText = out;
          appendBot(out);
        });
      }, 80);
    }, 300);
  }

  /* Study flow */
  function openStudyFlow(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('study');
      const html = `
        <div class="system-msg-v4">Estudo ‚Äî Resumo e Quiz</div>
        <textarea id="${idBase}_src" placeholder="Cole texto para resumo" style="width:100%;height:100px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)"></textarea>
        <div style="display:flex;gap:8px">
          <button id="${idBase}_summary" style="padding:6px 8px;border-radius:8px">Gerar resumo</button>
          <button id="${idBase}_quiz" style="padding:6px 8px;border-radius:8px">Gerar quiz (3 perguntas)</button>
        </div>
        <div id="${idBase}_out" style="margin-top:8px"></div>
      `;
      appendBot(html, html);
      setTimeout(()=> {
        document.getElementById(`${idBase}_summary`)?.addEventListener('click', ()=> {
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole um texto para eu resumir.'); return; }
          const sentences = s.split(/[.?!]\s+/).filter(Boolean);
          const top = sentences.slice(0, Math.min(3, sentences.length)).join('. ') + (sentences.length>3? '‚Ä¶':'');
          const res = `Resumo curto: ${top}`;
          document.getElementById(`${idBase}_out`).innerText = res;
          appendBot(res);
        });
        document.getElementById(`${idBase}_quiz`)?.addEventListener('click', ()=> {
          const s = document.getElementById(`${idBase}_src`).value.trim();
          if(!s){ appendBot('Cole um texto para eu gerar perguntas.'); return; }
          const sentences = s.split(/[.?!]\s+/).filter(Boolean);
          const q = sentences.slice(0,3).map((sen,i)=> `Pergunta ${i+1}: Sobre "${sen.slice(0,40)}..." ‚Äî responda em 1 frase.`).join('\n');
          document.getElementById(`${idBase}_out`).innerText = q;
          appendBot(q);
        });
      }, 80);
    }, 300);
  }

  /* productivity flow */
  function openProductivityFlow(orig){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const idBase = uid('prod');
      const html = `
        <div class="system-msg-v4">Produtividade ‚Äî Mini-Pomodoro</div>
        <div style="display:flex;gap:8px;flex-direction:column">
          <label>Tempo trabalho (min): <input id="${idBase}_work" value="25" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)"/></label>
          <label>Tempo pausa (min): <input id="${idBase}_break" value="5" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)"/></label>
          <div style="display:flex;gap:8px"><button id="${idBase}_start">Iniciar Pomodoro</button><button id="${idBase}_stop">Parar</button></div>
          <div id="${idBase}_status" style="margin-top:8px"></div>
        </div>
      `;
      appendBot(html, html);
      setTimeout(()=> {
        let timer = null; let remaining=0; let mode='work';
        const status = document.getElementById(`${idBase}_status`);
        function tick(){
          if(remaining<=0){
            if(mode==='work'){ mode='break'; remaining = parseInt(document.getElementById(`${idBase}_break`).value || 5)*60; appendBot('Pausa! Agora descanso curto.'); }
            else { mode='work'; remaining = parseInt(document.getElementById(`${idBase}_work`).value || 25)*60; appendBot('Volta ao trabalho!'); }
          }
          remaining--; const mm = Math.floor(remaining/60); const ss = remaining%60;
          if(status) status.innerText = `${mode.toUpperCase()}: ${mm}:${ss.toString().padStart(2,'0')}`;
        }
        document.getElementById(`${idBase}_start`)?.addEventListener('click', ()=> {
          remaining = parseInt(document.getElementById(`${idBase}_work`).value || 25)*60;
          if(timer) clearInterval(timer);
          timer = setInterval(tick, 1000);
          appendBot('Pomodoro iniciado. Boa produtividade!');
        });
        document.getElementById(`${idBase}_stop`)?.addEventListener('click', ()=> {
          if(timer) clearInterval(timer); timer = null; if(status) status.innerText = 'Parado';
          appendBot('Pomodoro parado.');
        });
      },80);
    },300);
  }

  /* simulate climate */
  function simulateClimate(text){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const res = choose([
        'Clima da equipe: est√°vel ‚Äî sugiro uma reuni√£o r√°pida de alinhamento.',
        'Clima: algumas tens√µes detectadas (mensagens recentes). Talvez feedback 1:1 ajude.',
        'Clima: positivo! Continue com reconhecimento de pequenos resultados.'
      ]);
      appendBot(res);
    }, 400);
  }

  /* read entire page (up to a limit) */
  function readEntirePage(){
    const raw = document.body?.innerText || document.documentElement?.innerText || '';
    const cleaned = raw.replace(/\s+/g,' ').trim().slice(0,2000);
    appendBot('Lendo a p√°gina... (m√°x 2000 chars)'); speak(cleaned);
  }

  /* local conversation summary */
  function generateLocalSummary(){
    const last = state.history.slice(-10).map(h => `${h.role === 'user' ? 'User' : (h.role==='assistant'?'AI':'Sys')}: ${h.text}`).join(' ‚Ä¢ ');
    return `Resumo (√∫ltimas mensagens): ${last || 'nenhuma mensagem'}`;
  }

  /* export history (download) */
  function exportHistory(){
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'flexai_history.json'; a.click();
    URL.revokeObjectURL(url);
    appendBot('Hist√≥rico exportado (download iniciado).');
  }

  /* speak (TTS) */
  function speak(text){
    try {
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch(e){ console.warn('speak fail', e); }
  }

  /* voice recognition setup */
  let recognition = null;
  try {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR) { recognition = new SR(); recognition.lang = 'pt-BR'; recognition.interimResults = false; }
  } catch(e){ recognition = null; }

  if(VOICE_BTN){
    VOICE_BTN.addEventListener('click', ()=>{
      if(!recognition){ appendBot('Reconhecimento de voz n√£o suportado neste navegador.'); return; }
      try {
        recognition.start();
        appendBot('üéôÔ∏è Estou ouvindo ‚Äî fale agora.');
      } catch(e){ console.warn(e); }
    });
    if(recognition){
      recognition.onresult = (ev) =>{
        const speech = ev.results[0][0].transcript;
        INPUT.value = speech;
        appendUser(speech);
        showTyping();
        setTimeout(()=>{ hideTyping(); handleText(speech); }, 400);
      };
      recognition.onerror = (e)=> appendBot('Erro de reconhecimento de voz: ' + (e.error||e.message));
    }
  }

  /* -------------------------
     Advanced intents: Programming & Robotics handlers
     ------------------------- */

  function handleProgramming(text){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const t = text.toLowerCase();

      // Detect language
      const lang = (t.match(/\b(c\+\+|cpp)\b/) ? 'cpp' :
                   (t.match(/\bpython\b/) ? 'python' :
                   (t.match(/\bjava\b/) ? 'java' :
                   (t.match(/\bhtml|css\b/) ? 'web' :
                   (t.match(/\b(sql|mysql|postgres|sqlite)\b/) ? 'sql' : 'general')))));

      if(lang === 'cpp'){
        appendBot('Quer ajuda com C++: posso explicar ponteiros, refer√™ncias, classes, templates ou revisar um trecho de c√≥digo. Cola o trecho que quer revisar ou diga o que quer aprender.');
        return;
      }
      if(lang === 'python'){
        appendBot('Python detectado ‚Äî posso revisar c√≥digo, explicar conceitos (listas, dicts, classes) e sugerir melhorias. Cola o c√≥digo aqui.');
        return;
      }
      if(lang === 'sql'){
        appendBot('SQL: descreva a tabela e a consulta que deseja criar/otimizar. Posso sugerir SELECTs, JOINs e √≠ndices.');
        return;
      }
      if(lang === 'web'){
        appendBot('Web dev: HTML/CSS/JS ‚Äî posso oferecer exemplos, corrigir markup ou melhorar acessibilidade. Cola o trecho ou descreve o problema.');
        return;
      }

      // Generic programming help
      if(/\b(erro|bug|exce√ß√£o|exception|crash|falha)\b/.test(t)) appendBot('Manda o erro completo ou o trecho do c√≥digo que est√° causando problema e eu analiso.');
      else appendBot('Diz o que voc√™ quer: exemplo, corre√ß√£o, explica√ß√£o de conceito ou gerar um snippet?');

    }, 320);
  }

  function handleRobotics(text){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      const t = text.toLowerCase();

      if(/\b(seguidor de linha|linha)\b/.test(t)){
        appendBot('Seguidor de linha: geralmente usa sensores IR para detectar contraste. Estrat√©gias: threshold simples, PID para ajuste fino, leitura multi-sensor (vetor de peso). Quer um exemplo de c√≥digo (Arduino/Spike?)');
        return;
      }
      if(/\b(sum[o√≥]|sumo)\b/.test(t)){
        appendBot('Sum√¥: prioridades ‚Äî detectar borda (n√£o cair), atacar o oponente (procura por diferen√ßa de dist√¢ncia), e sair de canto. Posso montar 3 estrat√©gias diferentes pra voc√™.');
        return;
      }
      if(/\b(spike prime|lego spike|spike)\b/.test(t)){
        appendBot('Spike Prime: trabalho com Python (MicroPython-like). Posso ajudar com motor control, sensores de cor/ultrassom e l√≥gica para sum√¥/seguidor. Cola seu c√≥digo ou descreve sensores.');
        return;
      }
      if(/\brobocode\b/.test(t)){
        appendBot('Robocode: posso ajudar com mira, movimento e radar. Se voc√™ colar parte do seu rob√¥ (Java), eu tento melhorar a mira lateral e o ajuste de pot√™ncia de tiro.');
        return;
      }

      appendBot('Me descreve o rob√¥, sensores e o que quer: seguir linha, evitar obst√°culos, sum√¥? Com isso gero um plano e exemplos de c√≥digo.');
    }, 320);
  }

  /* -------------------------
     Wellbeing (non-medical)
     ------------------------- */
  function handleWellbeing(text){
    showTyping();
    setTimeout(()=>{
      hideTyping();
      appendBot(personalityPick(state.mode, 'fallback') + ' ' + choose(['Se quiser, posso sugerir um plano de descanso simples.','Quer falar mais sobre isso?']));
    }, 300);
  }

  /* -------------------------
     Calculation
     ------------------------- */
  function handleCalculate(text){
    const cleaned = text.replace(/[^0-9+\-*/().,%\s]/g,'').replace(',', '.');
    const val = safeEval(cleaned);
    if(val !== null) appendBot(`Resultado: ${val}`);
    else appendBot('N√£o consegui calcular isso com seguran√ßa ‚Äî digite apenas a express√£o matem√°tica (ex: 12*3 + (4/2)).');
  }

  /* -------------------------
     Misc helpers
     ------------------------- */

  function chooseArr(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  /* -------------------------
     Input bindings & actions toolbar
     ------------------------- */

  if(FORM) FORM.addEventListener('submit', (ev)=> {
    ev.preventDefault();
    const txt = INPUT?.value.trim();
    if(!txt) return;
    if(INPUT) INPUT.value = '';
    appendUser(txt);
    showTyping();
    setTimeout(()=> { hideTyping(); handleText(txt); }, 200);
  });

  ACTIONS?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    if(act === 'tasks') openTasksUI();
    else if(act === 'schedule') openSchedulerPrompt();
    else if(act === 'rephrase') openRephraseFlow();
    else if(act === 'study') openStudyFlow();
    else if(act === 'prod') openProductivityFlow();
    else if(act === 'readpage') readEntirePage();
    else if(act === 'summary') appendBot(generateLocalSummary());
    else if(act === 'export') exportHistory();
  });

  /* Toggle panel open/close */
  TOGGLE?.addEventListener('click', ()=> {
    if(PANEL) PANEL.style.display = 'flex';
    PANEL?.setAttribute('aria-hidden','false');
    TOGGLE.style.display = 'none';
    INPUT?.focus();
  });
  CLOSE?.addEventListener('click', ()=> {
    if(PANEL) PANEL.style.display = 'none';
    PANEL?.setAttribute('aria-hidden','true');
    TOGGLE.style.display = 'inline-block';
  });

  /* Mode selector */
  MODE.value = state.mode || 'friendly';
  MODE?.addEventListener('change', ()=> { state.mode = MODE.value; localStorage.setItem('flexai_mode', state.mode); appendSystem('Modo: ' + state.mode); });

  SOUND_BTN?.addEventListener('click', ()=> {
    state.sound = !state.sound; SOUND_BTN.setAttribute('aria-pressed', state.sound ? 'true' : 'false'); saveState();
    appendSystem('Leitura autom√°tica ' + (state.sound ? 'ativada' : 'desativada'));
  });

  /* overlay hints on card hover */
  document.querySelectorAll('.card').forEach(card=>{
    card.addEventListener('mouseenter', ()=>{
      const title = card.querySelector('.card-title')?.innerText || 'um espa√ßo';
      OVERLAY.style.display = 'block';
      OVERLAY.textContent = `Dica da FlexAI: quer informa√ß√µes sobre "${title}"? Pergunte-me!`;
      setTimeout(()=> OVERLAY.style.display = 'none', 2200);
      if(state.sound) speak(`Voc√™ passou por ${title}`);
    });
  });

  /* keyboard shortcuts */
  document.addEventListener('keydown', (e)=>{
    // focus input with "/"
    if(e.key === '/' && document.activeElement !== INPUT){
      e.preventDefault();
      INPUT?.focus();
    }
    // open panel with ctrl+/
    if((e.ctrlKey || e.metaKey) && e.key === '/'){
      TOGGLE?.click();
    }
  });

  /* Save on unload */
  window.addEventListener('beforeunload', saveState);

  /* initial render */
  function renderAll(){
    if(!BODY) return;
    BODY.innerHTML = '';
    (state.history || []).forEach(m => renderMessage(m));
  }
  renderAll();
  if(state.history.length===0) appendBot(personalityPick(state.mode, 'greet'));

  /* Expose API for dev console */
  window.FlexAIv4 = {
    state,
    open: ()=> { TOGGLE?.click(); },
    close: ()=> { CLOSE?.click(); },
    speak,
    saveState,
    appendBot
  };

  /* -------------------------
     END FLEXAI v4
     ------------------------- */
})();
</script>
<!-- ===== FLEXAI v4 TURBO ‚Äî PARTE 2 FIM ===== -->

</body>
</html>
